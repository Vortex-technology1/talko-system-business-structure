<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#22c55e">
    <title>TALKO System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root {
        --primary-color: #4299e1;
        --success-color: #48bb78;
        --danger-color: #e53e3e;
        --warning-color: #ed8936;
        --purple-color: #9f7aea;
        --gray-50: #f7fafc;
        --gray-100: #edf2f7;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e0;
        --gray-400: #a0aec0;
        --gray-500: #718096;
        --gray-600: #4a5568;
        --gray-700: #2d3748;
        --gray-800: #1a202c;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        --shadow-lg: 0 12px 30px rgba(0,0,0,0.25);
        --border-radius: 8px;
        --border-radius-lg: 12px;
        --transition: all 0.2s ease;
    }

    .talko-system-wrapper * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .talko-system-wrapper {
        font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ffffff;
        overflow: hidden;
        line-height: 1.5;
        z-index: 99999;
    }

    /* === LOADING OVERLAY (ДОДАНО) === */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        flex-direction: column;
        gap: 16px;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--gray-200);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        color: var(--gray-600);
        font-size: 14px;
        font-weight: 500;
    }

    /* === CONNECTION STATUS INDICATOR (ПОКРАЩЕНО) === */
    .connection-status {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success-color);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 10000;
        transition: var(--transition);
        opacity: 0;
        pointer-events: none;
    }

    .connection-status.show {
        opacity: 1;
        pointer-events: auto;
    }

    .connection-status.offline {
        background: var(--danger-color);
    }

    .connection-status.syncing {
        background: var(--warning-color);
    }

    .connection-status.saving {
        background: var(--purple-color);
    }

    .connection-dot {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }

    /* === LOGIN SCREEN === */
    .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .login-card {
        background: white;
        border-radius: 16px;
        padding: 40px;
        width: 400px;
        max-width: 90vw;
        box-shadow: var(--shadow-lg);
        text-align: center;
    }

    .login-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 8px;
    }

    .login-subtitle {
        color: var(--gray-500);
        margin-bottom: 32px;
        font-size: 16px;
    }

    .login-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .login-input {
        padding: 12px 16px;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition);
        width: 100%;
    }

    .login-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .login-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 8px;
        position: relative;
    }

    .login-btn:hover:not(:disabled) {
        background: #3182ce;
        transform: translateY(-1px);
    }

    .login-btn:disabled {
        background: var(--gray-400);
        cursor: not-allowed;
        transform: none;
    }

    .login-btn.loading::after {
        content: '';
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .login-error {
        color: var(--danger-color);
        font-size: 14px;
        margin-top: 8px;
        display: none;
        padding: 10px;
        background: rgba(229, 62, 62, 0.1);
        border-radius: var(--border-radius);
    }

    .login-error.show {
        display: block;
    }

    .login-loading {
        color: var(--gray-500);
        font-size: 14px;
        margin-top: 8px;
    }

    /* === LANGUAGE SELECTOR === */
    .language-selector {
        position: absolute;
        top: 70px;
        right: 20px;
        z-index: 10000;
    }

    .language-dropdown {
        position: relative;
    }

    .language-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 3px;
        transition: var(--transition);
        color: var(--gray-700);
        min-width: 60px;
        height: 28px;
    }

    .language-btn:hover {
        background: white;
        box-shadow: var(--shadow-sm);
    }

    .language-options {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        min-width: 120px;
        display: none;
        z-index: 10001;
        margin-top: 4px;
    }

    .language-options.show {
        display: block;
        animation: slideDown 0.2s ease;
    }

    .language-option {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .language-option:first-child {
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .language-option:last-child {
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .language-option:hover {
        background: var(--gray-50);
    }

    .language-option.active {
        background: var(--primary-color);
        color: white;
    }

    .language-flag {
        width: 14px;
        height: 10px;
        border-radius: 2px;
        display: inline-block;
        flex-shrink: 0;
    }

    .flag-uk { background: linear-gradient(to bottom, #005BBB 50%, #FFD500 50%); }
    .flag-ru { background: linear-gradient(to bottom, #FFFFFF 33%, #0039A6 33%, #0039A6 66%, #D52B1E 66%); }
    .flag-en { background: linear-gradient(45deg, #012169 25%, #FFFFFF 25%, #FFFFFF 50%, #C8102E 50%, #C8102E 75%, #FFFFFF 75%); }
    .flag-bg { background: linear-gradient(to bottom, #FFFFFF 33%, #00966E 33%, #00966E 66%, #D62612 66%); }

    /* === DROPDOWNS (ECOSYSTEM & EXPORT) === */
    .ecosystem-dropdown,
    .export-dropdown {
        position: relative;
    }

    .ecosystem-menu,
    .export-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        display: none;
        z-index: 1001;
        margin-top: 8px;
    }

    .ecosystem-menu {
        min-width: 320px;
    }

    .export-menu {
        min-width: 180px;
    }

    .ecosystem-menu.show,
    .export-menu.show {
        display: block;
        animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ecosystem-menu-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--gray-200);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        font-size: 14px;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .ecosystem-menu-item {
        padding: 14px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: var(--gray-700);
        transition: var(--transition);
        border-bottom: 1px solid var(--gray-100);
    }

    .ecosystem-menu-item:last-child {
        border-bottom: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .ecosystem-menu-item:hover {
        background: var(--gray-50);
    }

    .ecosystem-menu-item:hover .ecosystem-item-title {
        color: var(--primary-color);
    }

    .ecosystem-icon {
        width: 32px;
        height: 32px;
        background: var(--gray-100);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        color: var(--gray-600);
        transition: var(--transition);
    }

    .ecosystem-menu-item:hover .ecosystem-icon {
        background: var(--primary-color);
        color: white;
    }

    .ecosystem-item-content {
        flex: 1;
    }

    .ecosystem-item-title {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 2px;
        color: var(--gray-700);
    }

    .ecosystem-item-desc {
        font-size: 11px;
        color: var(--gray-500);
    }

    .ecosystem-divider {
        height: 1px;
        background: var(--gray-200);
        margin: 8px 0;
    }

    .ecosystem-section-title {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-400);
        padding: 8px 16px 4px;
    }

    .ecosystem-menu-item.ai-assistant {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
    }

    .ecosystem-menu-item.ai-assistant:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
    }

    .ecosystem-menu-item.ai-assistant .ecosystem-item-title {
        color: #7c3aed;
    }

    .ecosystem-icon.ai {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
    }

    .ecosystem-icon.ai svg {
        stroke: white;
    }

    .export-menu-item {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        color: var(--gray-700);
        transition: var(--transition);
        border-bottom: 1px solid var(--gray-100);
        font-size: 13px;
        font-weight: 500;
    }

    .export-menu-item:last-child {
        border-bottom: none;
    }

    .export-menu-item:hover {
        background: var(--gray-50);
        color: var(--primary-color);
    }

    .export-menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .export-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    /* === AI ASSISTANTS DROPDOWN === */
    .ai-dropdown {
        position: relative;
    }

    .ai-dropdown .dropdown-arrow {
        margin-left: 4px;
        transition: transform 0.2s;
    }

    .ai-dropdown.open .dropdown-arrow {
        transform: rotate(180deg);
    }

    .ai-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 280px;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        display: none;
        z-index: 1001;
        overflow: hidden;
    }

    .ai-menu.show {
        display: block;
        animation: slideDown 0.2s ease;
    }

    .ai-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        text-decoration: none;
        color: var(--gray-700);
        transition: all 0.2s;
        border-bottom: 1px solid var(--gray-100);
    }

    .ai-menu-item:last-child {
        border-bottom: none;
    }

    .ai-menu-item:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%);
    }

    .ai-menu-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        flex-shrink: 0;
    }

    .ai-menu-icon svg {
        stroke: white;
    }

    .ai-menu-content {
        flex: 1;
        min-width: 0;
    }

    .ai-menu-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--gray-800);
        margin-bottom: 2px;
    }

    .ai-menu-desc {
        font-size: 11px;
        color: var(--gray-500);
        line-height: 1.3;
    }

    .ai-menu-item:hover .ai-menu-title {
        color: #7c3aed;
    }

    /* === SUPPORT DROPDOWN === */
    .support-dropdown {
        position: relative;
    }

    .support-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 260px;
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: var(--transition);
        overflow: hidden;
    }

    .support-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .support-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        color: var(--gray-700);
        text-decoration: none;
        transition: var(--transition);
        border-bottom: 1px solid var(--gray-100);
    }

    .support-menu-item:last-child {
        border-bottom: none;
    }

    .support-menu-item:hover {
        background: var(--gray-50);
    }

    .support-menu-item:hover .support-item-title {
        color: var(--success-color);
    }

    .support-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .support-icon.ai {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
    }

    .support-icon.ai svg {
        stroke: white;
    }

    .support-icon.telegram {
        background: linear-gradient(135deg, #0088cc 0%, #0077b5 100%);
        color: white;
    }

    .support-icon.backup {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .support-menu-divider {
        height: 1px;
        background: var(--gray-200);
        margin: 8px 0;
    }

    /* Backup Modal Styles */
    .backup-modal .modal-content {
        max-width: 500px;
    }

    .backup-warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        font-size: 14px;
        color: #92400e;
    }

    .backup-list-container {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
    }

    .backup-list {
        display: flex;
        flex-direction: column;
    }

    .backup-loading {
        padding: 24px;
        text-align: center;
        color: var(--gray-500);
    }

    .backup-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--gray-100);
        cursor: pointer;
        transition: background 0.2s;
    }

    .backup-item:last-child {
        border-bottom: none;
    }

    .backup-item:hover {
        background: var(--gray-50);
    }

    .backup-item-info {
        flex: 1;
    }

    .backup-item-date {
        font-weight: 600;
        font-size: 14px;
        color: var(--gray-800);
        margin-bottom: 2px;
    }

    .backup-item-meta {
        font-size: 12px;
        color: var(--gray-500);
    }

    .backup-item-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .backup-item-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .backup-empty {
        padding: 32px;
        text-align: center;
        color: var(--gray-500);
    }

    .backup-error {
        padding: 16px;
        text-align: center;
        color: #dc2626;
        background: rgba(220, 38, 38, 0.1);
        border-radius: 8px;
        margin: 16px;
    }

    .support-item-content {
        flex: 1;
        min-width: 0;
    }

    .support-item-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--gray-800);
        margin-bottom: 2px;
    }

    .support-item-desc {
        font-size: 11px;
        color: var(--gray-500);
    }

    /* === USER INFO === */
    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--gray-600);
        font-size: 14px;
        max-width: 180px;
        margin-right: 12px;
    }

    .user-email {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 120px;
    }

    .logout-btn {
        background: none;
        border: 1px solid var(--gray-200);
        color: var(--gray-600);
        padding: 6px 12px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 12px;
        transition: var(--transition);
        white-space: nowrap;
        flex-shrink: 0;
    }

    .logout-btn:hover {
        background: var(--gray-50);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }

    /* === TOOLBAR === */
    .toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: #ffffff;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        padding: 0 20px;
        z-index: 1000;
        box-shadow: var(--shadow-sm);
    }

    .toolbar-left,
    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toolbar-right {
        margin-left: auto;
    }

    .logo {
        font-size: 18px;
        font-weight: 700;
        color: var(--gray-700);
        margin-right: 8px;
    }

    .tool-btn {
        height: 40px;
        border: 1px solid var(--gray-200);
        background: white;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        padding: 0 16px;
        white-space: nowrap;
        text-decoration: none;
        color: var(--gray-700);
    }

    .tool-btn span {
        color: inherit;
    }

    .tool-btn:hover {
        background: var(--gray-50);
        border-color: var(--gray-300);
        transform: translateY(-1px);
    }

    .tool-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .tool-btn.add-btn {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .tool-btn.add-btn:hover {
        background: #38a169;
        border-color: #38a169;
    }

    .tool-btn.support-btn {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        border: none;
    }

    .tool-btn.support-btn span {
        color: white !important;
    }

    .tool-btn.support-btn:hover {
        background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    }

    .tool-btn.ai-btn {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        border: none;
        gap: 6px;
    }

    .tool-btn.ai-btn:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .ai-icon {
        display: inline-flex;
        align-items: center;
        margin-right: 4px;
    }

    .ai-icon svg {
        width: 16px;
        height: 16px;
        vertical-align: middle;
    }

    @keyframes pulse-ai {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* === CANVAS === */
    .canvas-container {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ffffff;
        overflow: hidden;
        cursor: grab;
    }

    .canvas-container.panning {
        cursor: grabbing;
    }

    .canvas-container.connecting {
        cursor: crosshair;
    }

    .canvas {
        position: relative;
        width: 5000px;
        height: 5000px;
        background-image: radial-gradient(circle, var(--gray-200) 1px, transparent 1px);
        background-size: 20px 20px;
        background-position: 0 0;
        transform-origin: 0 0;
        will-change: transform;
    }

    /* === CONNECTION LINES === */
    .connection-line {
        position: absolute;
        pointer-events: none;
        z-index: 1;
    }

    .connection-group {
        cursor: pointer;
        transition: var(--transition);
    }

    .connection-group:hover .connection-path {
        stroke: var(--danger-color) !important;
        stroke-width: 3 !important;
    }

    /* === FUNCTION CARDS === */
    .function-card {
        position: absolute;
        width: 280px;
        min-height: 200px;
        background: #ffffff;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        border: 2px solid transparent;
        cursor: move;
        transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
        user-select: none;
        will-change: transform, left, top;
    }

    .function-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .function-card.selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .function-card.connecting {
        border-color: var(--warning-color);
        box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
        cursor: crosshair;
    }

    .function-card.connect-target {
        border-color: var(--success-color);
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.3);
    }

    .function-card.dragging {
        z-index: 1000;
        transform: rotate(2deg) scale(1.02);
        box-shadow: var(--shadow-lg);
        transition: none;
    }

    .card-header {
        padding: 16px;
        border-radius: 10px 10px 0 0;
        position: relative;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card-header.blue { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
    .card-header.green { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
    .card-header.purple { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); }
    .card-header.red { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
    .card-header.orange { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
    .card-header.teal { background: linear-gradient(135deg, #4fd1c7 0%, #38b2ac 100%); }
    .card-header.pink { background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%); }
    .card-header.yellow { background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%); color: var(--gray-800); }

    .card-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.2;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .card-responsible {
        font-size: 13px;
        opacity: 0.9;
    }

    .card-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: var(--transition);
    }

    .function-card:hover .card-actions {
        opacity: 1;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.2);
        color: white;
        transition: var(--transition);
    }

    .action-btn svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }

    .action-btn.delete {
        background: rgba(239, 68, 68, 0.8);
    }

    .action-btn.delete:hover {
        background: rgba(220, 38, 38, 0.9);
        transform: scale(1.15);
    }

    .plus-btn {
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 30px;
        border: 2px solid var(--primary-color);
        background: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        opacity: 0;
        transition: var(--transition);
        z-index: 10;
    }

    .plus-btn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .function-card:hover .plus-btn {
        opacity: 1;
    }

    .plus-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(-50%) scale(1.1);
    }

    .card-body {
        padding: 16px;
    }

    .card-field {
        margin-bottom: 12px;
    }

    .card-field:last-child {
        margin-bottom: 0;
    }

    .field-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .field-value {
        font-size: 14px;
        color: var(--gray-700);
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .field-link {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .field-link:hover {
        text-decoration: underline;
    }

    .employees-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }

    .employee-tag {
        background: var(--gray-100);
        color: var(--gray-600);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--gray-200);
    }

    .stat-item {
        text-align: center;
        border-radius: var(--border-radius);
        padding: 8px;
        transition: var(--transition);
        border: 1px solid;
    }

    .stat-item.blue { background: rgba(66, 153, 225, 0.1); border-color: rgba(66, 153, 225, 0.2); }
    .stat-item.green { background: rgba(72, 187, 120, 0.1); border-color: rgba(72, 187, 120, 0.2); }
    .stat-item.red { background: rgba(245, 101, 101, 0.1); border-color: rgba(245, 101, 101, 0.2); }
    .stat-item.yellow { background: rgba(236, 201, 75, 0.1); border-color: rgba(236, 201, 75, 0.2); }
    .stat-item.purple { background: rgba(159, 122, 234, 0.1); border-color: rgba(159, 122, 234, 0.2); }
    .stat-item.orange { background: rgba(237, 137, 54, 0.1); border-color: rgba(237, 137, 54, 0.2); }
    .stat-item.teal { background: rgba(79, 209, 199, 0.1); border-color: rgba(79, 209, 199, 0.2); }
    .stat-item.pink { background: rgba(237, 100, 166, 0.1); border-color: rgba(237, 100, 166, 0.2); }
    .stat-item.gray { background: rgba(113, 128, 150, 0.1); border-color: rgba(113, 128, 150, 0.2); }

    .stat-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--gray-700);
    }

    .stat-label {
        font-size: 10px;
        color: var(--gray-500);
        margin-top: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* === MODALS === */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(4px);
    }

    .modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        width: 500px;
        max-width: 95vw;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid var(--gray-200);
        flex-shrink: 0;
    }

    .modal-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--gray-700);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-600);
        margin-bottom: 6px;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 14px;
        transition: var(--transition);
        font-family: inherit;
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .form-input.error,
    .form-textarea.error {
        border-color: var(--danger-color);
    }

    .form-error {
        color: var(--danger-color);
        font-size: 12px;
        margin-top: 4px;
    }

    .color-picker {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 8px;
    }

    .color-option {
        width: 40px;
        height: 40px;
        border-radius: var(--border-radius);
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition);
    }

    .color-option:hover {
        transform: scale(1.05);
    }

    .color-option.selected {
        border-color: var(--gray-700);
        transform: scale(1.1);
    }

    .color-option.default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .color-option.blue { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
    .color-option.green { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
    .color-option.purple { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); }
    .color-option.red { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
    .color-option.orange { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
    .color-option.teal { background: linear-gradient(135deg, #4fd1c7 0%, #38b2ac 100%); }
    .color-option.pink { background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%); }

    /* === EMPLOYEES INPUT === */
    .employees-input {
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 8px;
        min-height: 45px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        cursor: text;
    }

    .employees-input:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .employee-input-tag {
        background: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .remove-employee {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        opacity: 0.8;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-employee svg {
        width: 12px;
        height: 12px;
    }

    .remove-employee:hover {
        opacity: 1;
    }

    .employee-input-field {
        border: none;
        outline: none;
        flex-grow: 1;
        min-width: 120px;
        font-size: 14px;
        font-family: inherit;
    }

    /* === STATISTICS FORM === */
    .stats-form-group {
        margin-bottom: 20px;
    }

    .stat-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        padding: 8px;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        cursor: move;
        transition: var(--transition);
        background: white;
    }

    .stat-input-row:hover {
        box-shadow: var(--shadow-sm);
    }

    .stat-input-row.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .drag-handle {
        width: 20px;
        height: 20px;
        background: var(--gray-200);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: grab;
        color: var(--gray-500);
        flex-shrink: 0;
    }

    .drag-handle svg {
        width: 12px;
        height: 12px;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    .stat-color-selector {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        border: 2px solid var(--gray-200);
        cursor: pointer;
        transition: var(--transition);
        flex-shrink: 0;
    }

    .stat-color-selector:hover {
        transform: scale(1.1);
    }

    .stat-name-input,
    .stat-value-input {
        flex: 1;
        padding: 8px;
        border: 1px solid var(--gray-200);
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
    }

    .stat-value-input {
        flex: 0.8;
    }

    .remove-stat-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: var(--danger-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        flex-shrink: 0;
    }

    .remove-stat-btn svg {
        width: 12px;
        height: 12px;
    }

    .remove-stat-btn:hover {
        background: #c53030;
        transform: scale(1.1);
    }

    .add-stat-btn {
        width: 100%;
        padding: 8px;
        border: 2px dashed var(--gray-200);
        background: transparent;
        border-radius: var(--border-radius);
        cursor: pointer;
        color: var(--gray-500);
        font-size: 14px;
        transition: var(--transition);
        font-family: inherit;
    }

    .add-stat-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .stat-color-dropdown {
        position: relative;
        display: inline-block;
    }

    .stat-color-options {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        display: none;
        z-index: 1000;
        padding: 8px;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        margin-top: 4px;
    }

    .stat-color-options.show {
        display: grid;
    }

    .stat-color-option {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid var(--gray-200);
        transition: var(--transition);
    }

    .stat-color-option:hover {
        transform: scale(1.1);
    }

    .stat-color-option.blue { background: rgba(66, 153, 225, 0.8); }
    .stat-color-option.green { background: rgba(72, 187, 120, 0.8); }
    .stat-color-option.red { background: rgba(245, 101, 101, 0.8); }
    .stat-color-option.yellow { background: rgba(236, 201, 75, 0.8); }
    .stat-color-option.purple { background: rgba(159, 122, 234, 0.8); }
    .stat-color-option.orange { background: rgba(237, 137, 54, 0.8); }
    .stat-color-option.teal { background: rgba(79, 209, 199, 0.8); }
    .stat-color-option.pink { background: rgba(237, 100, 166, 0.8); }
    .stat-color-option.gray { background: rgba(113, 128, 150, 0.8); }

    /* === BUTTONS === */
    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
    }

    .btn {
        padding: 10px 20px;
        border-radius: var(--border-radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid;
        font-family: inherit;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover:not(:disabled) {
        background: #3182ce;
        border-color: #3182ce;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: white;
        color: var(--gray-600);
        border-color: var(--gray-200);
    }

    .btn-secondary:hover:not(:disabled) {
        background: var(--gray-50);
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
    }

    .btn-danger:hover:not(:disabled) {
        background: #c53030;
        border-color: #c53030;
    }

    /* === ZOOM CONTROLS === */
    .zoom-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 100;
    }

    .zoom-btn {
        width: 40px;
        height: 40px;
        border: 1px solid var(--gray-200);
        background: white;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        color: var(--gray-700);
    }

    .zoom-btn svg {
        width: 18px;
        height: 18px;
    }

    .zoom-btn:hover {
        background: var(--gray-50);
        transform: scale(1.1);
    }

    .zoom-level {
        text-align: center;
        font-size: 11px;
        color: var(--gray-500);
        background: white;
        padding: 4px 8px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
    }

    /* === EMPTY STATE === */
    .empty-state {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--gray-500);
    }

    .empty-state h3 {
        font-size: 24px;
        margin-bottom: 12px;
        color: var(--gray-600);
    }

    .empty-state p {
        font-size: 16px;
        margin-bottom: 24px;
    }

    .add-first-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
    }

    .add-first-btn:hover {
        background: #3182ce;
        transform: translateY(-1px);
    }

    /* === CONFIRM MODAL === */
    .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        backdrop-filter: blur(4px);
    }

    .confirm-modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .confirm-content {
        background: white;
        border-radius: 16px;
        width: 400px;
        max-width: 95vw;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .confirm-header {
        padding: 24px 24px 16px;
        border-bottom: 1px solid var(--gray-200);
    }

    .confirm-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--danger-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .confirm-body {
        padding: 16px 24px 24px;
        color: var(--gray-600);
    }

    .confirm-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* === NOTIFICATION TOAST === */
    .notification-toast {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        max-width: 300px;
        animation: slideInRight 0.3s ease;
    }

    .notification-toast.success { background: var(--success-color); }
    .notification-toast.error { background: var(--danger-color); }
    .notification-toast.warning { background: var(--warning-color); }
    .notification-toast.info { background: var(--primary-color); }

    .notification-toast.hiding {
        animation: slideOutRight 0.3s ease forwards;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* === TOUCH & MOBILE OPTIMIZATIONS === */
    @supports (padding: env(safe-area-inset-bottom)) {
        .toolbar {
            padding-left: max(12px, env(safe-area-inset-left));
            padding-right: max(12px, env(safe-area-inset-right));
        }

        .modal-footer {
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .zoom-controls {
            bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
            right: max(20px, env(safe-area-inset-right));
        }

        .notification-toast {
            bottom: max(70px, calc(env(safe-area-inset-bottom) + 60px));
        }
    }

    /* Touch feedback */
    .tool-btn,
    .btn,
    .action-btn,
    .plus-btn,
    .zoom-btn,
    .color-option,
    .language-btn,
    .ecosystem-item,
    .export-option {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }

    .tool-btn:active,
    .btn:active,
    .action-btn:active,
    .plus-btn:active,
    .zoom-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }

    /* Prevent text selection on drag */
    .function-card {
        -webkit-user-select: none;
        user-select: none;
        touch-action: none;
    }

    .function-card.dragging {
        opacity: 0.9;
        z-index: 1000;
    }

    /* Canvas touch improvements */
    .canvas-container {
        touch-action: none;
        overflow: hidden;
    }

    .canvas-container.panning {
        cursor: grabbing;
    }

    /* Smooth scrolling for modal */
    .modal-body {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }

    /* Fix iOS input zoom */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            font-size: 16px !important;
        }
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
        .function-card {
            width: 260px;
            min-height: 180px;
        }

        .card-header {
            padding: 14px;
        }

        .card-title {
            font-size: 15px;
        }

        .card-body {
            padding: 14px;
        }

        .modal-content {
            width: 95%;
            max-height: 90vh;
            margin: 10px;
            border-radius: 12px;
        }

        .modal-header {
            padding: 18px 20px;
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .modal-body {
            padding: 18px 20px;
        }

        .modal-footer {
            padding: 16px 20px;
        }

        .toolbar {
            padding: 0 10px;
            height: 56px;
            gap: 6px;
        }

        .toolbar-left,
        .toolbar-right {
            gap: 6px;
        }

        .tool-btn {
            padding: 0 10px;
            font-size: 10px;
            height: 38px;
            min-width: 38px;
        }

        .logo {
            font-size: 14px;
            margin-right: 4px;
        }

        .login-card {
            width: 92%;
            margin: 16px;
            padding: 28px 24px;
        }

        .login-title {
            font-size: 24px;
        }

        .login-subtitle {
            font-size: 14px;
            margin-bottom: 24px;
        }

        .user-info {
            max-width: 120px;
        }

        .user-email {
            max-width: 80px;
            font-size: 11px;
        }

        .logout-btn {
            padding: 6px 10px;
            font-size: 11px;
        }

        /* Hide text, show only icons on tablets */
        .tool-btn.ai-btn span:not(.ai-icon) {
            display: none;
        }

        .tool-btn.ai-btn .ai-icon {
            margin-right: 0;
        }

        .ecosystem-menu {
            min-width: 280px;
            right: -60px;
        }

        .export-menu {
            min-width: 160px;
        }

        .zoom-controls {
            bottom: 16px;
            right: 16px;
            gap: 6px;
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
        }

        .zoom-level {
            font-size: 10px;
            padding: 4px 6px;
        }

        .canvas-container {
            top: 56px;
        }

        .language-selector {
            top: 64px;
            right: 10px;
        }

        .language-btn {
            min-width: 50px;
            height: 26px;
            font-size: 9px;
        }

        /* Larger touch targets for card actions */
        .card-actions {
            gap: 8px;
            opacity: 1; /* Always visible on mobile */
        }

        .action-btn {
            width: 36px;
            height: 36px;
        }

        .plus-btn {
            width: 34px;
            height: 34px;
            bottom: -17px;
            opacity: 1; /* Always visible on mobile */
        }

        /* Show actions always on touch devices */
        .function-card .card-actions,
        .function-card .plus-btn {
            opacity: 1;
        }

        /* Stats grid on mobile */
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-item {
            padding: 6px;
        }

        .stat-value {
            font-size: 14px;
        }

        .stat-label {
            font-size: 9px;
        }
    }

    @media (max-width: 480px) {
        /* Toolbar becomes more compact */
        .toolbar {
            height: 52px;
            padding: 0 8px;
        }

        .logo {
            display: none;
        }

        .toolbar-left {
            gap: 4px;
        }

        .toolbar-right {
            gap: 4px;
        }

        /* Hide less important buttons on mobile */
        .tool-btn#copyBtn,
        .tool-btn#pasteBtn,
        .tool-btn#showAllBtn {
            display: none;
        }

        /* Compact buttons */
        .tool-btn {
            padding: 0 8px;
            font-size: 9px;
            height: 36px;
            min-width: 36px;
        }

        .tool-btn.add-btn {
            padding: 0 12px;
        }

        /* Icon-only mode for tools */
        .tool-btn#selectTool span,
        .tool-btn#handTool span,
        .tool-btn#connectTool span {
            display: none;
        }

        .tool-btn#selectTool::after {
            content: '⬚';
            font-size: 14px;
        }

        .tool-btn#handTool::after {
            content: '✋';
            font-size: 14px;
        }

        .tool-btn#connectTool::after {
            content: '⤵';
            font-size: 14px;
        }

        /* Ecosystem button - icon only */
        .tool-btn#ecosystemBtn span {
            display: none;
        }

        .tool-btn#ecosystemBtn::after {
            content: '⚙';
            font-size: 16px;
        }

        /* Export button - icon only */
        .tool-btn#exportBtn span {
            display: none;
        }

        .tool-btn#exportBtn::after {
            content: '↓';
            font-size: 16px;
        }

        /* Support button hidden on very small screens */
        .tool-btn.support-btn {
            display: none;
        }

        /* AI buttons - icon only on mobile */
        .tool-btn.ai-btn span:not(.ai-icon) {
            display: none;
        }

        .tool-btn.ai-btn .ai-icon {
            margin-right: 0;
        }

        .tool-btn.ai-btn {
            padding: 0 10px;
        }

        .function-card {
            width: 240px;
            min-height: 160px;
        }

        .card-header {
            padding: 12px;
        }

        .card-title {
            font-size: 14px;
        }

        .card-responsible {
            font-size: 12px;
        }

        .card-body {
            padding: 12px;
        }

        .card-field {
            margin-bottom: 10px;
        }

        .field-label {
            font-size: 10px;
        }

        .field-value {
            font-size: 13px;
        }

        .language-selector {
            top: 58px;
            right: 8px;
        }

        .language-btn {
            min-width: 44px;
            height: 28px;
            padding: 4px 6px;
        }

        #currentLanguageName {
            display: none;
        }

        .language-btn svg {
            display: none;
        }

        .user-info {
            display: none;
        }

        .ecosystem-menu,
        .export-menu {
            position: fixed;
            top: 52px;
            left: 8px;
            right: 8px;
            min-width: auto;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* Full-screen modals on mobile */
        .modal-content {
            width: 100%;
            height: 100%;
            max-height: 100%;
            margin: 0;
            border-radius: 0;
        }

        .modal-header {
            padding: 16px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 12px 16px;
            position: sticky;
            bottom: 0;
            background: white;
            z-index: 10;
        }

        .btn {
            padding: 12px 16px;
            font-size: 15px;
            flex: 1;
        }

        .modal-footer {
            gap: 10px;
        }

        /* Form inputs larger for touch */
        .form-input,
        .form-textarea {
            padding: 14px;
            font-size: 16px; /* Prevents iOS zoom */
        }

        .form-label {
            font-size: 12px;
        }

        /* Color picker larger */
        .color-picker {
            gap: 10px;
        }

        .color-option {
            width: 44px;
            height: 44px;
        }

        /* Stats form */
        .stat-input-row {
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
        }

        .stat-name-input,
        .stat-value-input {
            flex: 1 1 100%;
            padding: 12px;
            font-size: 16px;
        }

        .stat-color-selector {
            width: 36px;
            height: 36px;
        }

        .remove-stat-btn {
            width: 36px;
            height: 36px;
        }

        /* Employees input */
        .employees-input {
            padding: 10px;
            min-height: 50px;
        }

        .employee-input-field {
            font-size: 16px;
            padding: 8px 0;
        }

        .employee-input-tag {
            padding: 6px 10px;
            font-size: 13px;
        }

        /* Confirm modal */
        .confirm-content {
            width: 100%;
            max-width: 100%;
            margin: 0;
            border-radius: 0;
            height: auto;
            max-height: 100%;
        }

        .confirm-header {
            padding: 20px 16px 16px;
        }

        .confirm-body {
            padding: 16px;
        }

        .confirm-footer {
            padding: 16px;
        }

        /* Zoom controls */
        .zoom-controls {
            bottom: 12px;
            right: 12px;
        }

        .zoom-btn {
            width: 48px;
            height: 48px;
        }

        .zoom-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Canvas */
        .canvas-container {
            top: 52px;
        }

        /* Empty state */
        .empty-state h3 {
            font-size: 20px;
        }

        .empty-state p {
            font-size: 14px;
            padding: 0 20px;
        }

        .add-first-btn {
            padding: 14px 24px;
            font-size: 15px;
        }

        /* Mobile gesture hint */
        .empty-state::after {
            content: '👆 Pinch для zoom • ✋ Свайп для переміщення';
            display: block;
            margin-top: 24px;
            font-size: 12px;
            color: var(--gray-400);
            opacity: 0.8;
        }

        /* Login screen */
        .login-card {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 24px 20px;
            border-radius: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-title {
            font-size: 22px;
        }

        .login-subtitle {
            font-size: 13px;
        }

        .login-input {
            padding: 14px 16px;
            font-size: 16px;
        }

        .login-btn {
            padding: 14px 24px;
            font-size: 16px;
        }

        /* Notification toast */
        .notification-toast {
            top: auto;
            bottom: 70px;
            right: 12px;
            left: 12px;
            max-width: none;
            text-align: center;
        }

        /* Connection status */
        .connection-status {
            top: 56px;
            font-size: 11px;
            padding: 4px 12px;
        }

        /* Mobile FAB visible */
        .mobile-fab {
            display: flex;
        }

        /* Hide desktop add button when FAB is shown */
        .tool-btn.add-btn {
            display: none;
        }

        /* Bottom safe area spacing for zoom */
        .zoom-controls {
            bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        }
    }

    /* Extra small devices */
    @media (max-width: 360px) {
        .function-card {
            width: 220px;
        }

        .tool-btn.add-btn span {
            display: none;
        }

        .tool-btn.add-btn::after {
            content: '+';
            font-size: 18px;
            font-weight: bold;
        }

        .toolbar {
            height: 48px;
        }

        .canvas-container {
            top: 48px;
        }

        .card-actions {
            top: 8px;
            right: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
        }

        /* AI dropdown on very small screens */
        .ai-dropdown .ai-btn span:not(.ai-icon):not(.dropdown-arrow) {
            display: none;
        }
        
        .ai-dropdown .dropdown-arrow {
            margin-left: 2px;
        }

        .ai-menu {
            right: auto;
            left: 0;
            min-width: 260px;
        }

        .tool-btn.ai-btn {
            min-width: 32px;
            padding: 0 8px;
        }
    }

    /* Landscape mode on mobile */
    @media (max-height: 500px) and (orientation: landscape) {
        .modal-content {
            max-height: 100vh;
            height: 100vh;
        }

        .modal-body {
            max-height: calc(100vh - 120px);
        }

        .login-card {
            min-height: auto;
            padding: 20px;
        }

        .zoom-controls {
            flex-direction: row;
            bottom: 8px;
            right: 8px;
        }
    }

    /* Mobile FAB (Floating Action Button) for Add */
    .mobile-fab {
        display: none;
        position: fixed;
        bottom: 80px;
        right: 16px;
        width: 56px;
        height: 56px;
        background: var(--primary-gradient);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        z-index: 100;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .mobile-fab:active {
        transform: scale(0.9);
    }

    .mobile-fab svg {
        width: 24px;
        height: 24px;
    }

    @supports (padding: env(safe-area-inset-bottom)) {
        .mobile-fab {
            bottom: max(80px, calc(env(safe-area-inset-bottom) + 70px));
            right: max(16px, env(safe-area-inset-right));
        }
    }

    /* === PRINT STYLES === */
    @media print {
        .toolbar,
        .zoom-controls,
        .language-selector,
        .connection-status,
        .modal,
        .confirm-modal {
            display: none !important;
        }

        .canvas-container {
            top: 0;
            overflow: visible;
        }

        .canvas {
            transform: none !important;
        }

        .function-card {
            break-inside: avoid;
        }
    }
</style>

<div class="talko-system-wrapper">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Завантаження...</div>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot"></div>
        <span id="connectionText">Онлайн</span>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
        <div class="language-dropdown">
            <button class="language-btn" id="languageBtn" type="button" aria-haspopup="true" aria-expanded="false">
                <span class="language-flag flag-uk" id="currentLanguageFlag"></span>
                <span id="currentLanguageName">УКР</span>
                <span aria-hidden="true"><svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></span>
            </button>
            <div class="language-options" id="languageOptions" role="menu">
                <div class="language-option" data-lang="uk" role="menuitem" tabindex="0">
                    <span class="language-flag flag-uk"></span>
                    <span>Українська</span>
                </div>
                <div class="language-option" data-lang="ru" role="menuitem" tabindex="0">
                    <span class="language-flag flag-ru"></span>
                    <span>Русский</span>
                </div>
                <div class="language-option" data-lang="en" role="menuitem" tabindex="0">
                    <span class="language-flag flag-en"></span>
                    <span>English</span>
                </div>
                <div class="language-option" data-lang="bg" role="menuitem" tabindex="0">
                    <span class="language-flag flag-bg"></span>
                    <span>Български</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1 class="login-title" data-text="login.title">TALKO System</h1>
            <p class="login-subtitle" data-text="login.subtitle">Звільняє власника. Масштабує бізнес. Керує замість вас.</p>
            <p style="color: var(--gray-500); font-size: 14px; margin-top: 8px;" data-text="login.description">Це не просто "менеджмент", а система, що вивільняє час і ростить компанію</p>

            <form class="login-form" id="loginForm" novalidate>
                <input type="email" class="login-input" id="emailInput" data-placeholder="login.email" placeholder="Email" required autocomplete="email">
                <input type="password" class="login-input" id="passwordInput" data-placeholder="login.password" placeholder="Пароль" required autocomplete="current-password">
                <button type="submit" class="login-btn" id="loginBtn" data-text="login.button">Увійти</button>
            </form>

            <div class="login-error" id="loginError"></div>
            <div class="login-loading" id="loginLoading" style="display: none;" data-text="login.loading">Підключення...</div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="toolbar" role="toolbar">
            <div class="toolbar-left">
                <div class="logo">TALKO System</div>
                <button class="tool-btn add-btn" id="addFunctionBtn" type="button" data-title="toolbar.add_function">
                    <span data-text="toolbar.add">+ ДОДАТИ</span>
                </button>
                <button class="tool-btn active" id="selectTool" type="button" data-title="toolbar.select" aria-pressed="true">
                    <span data-text="toolbar.select">ВИБІР</span>
                </button>
                <button class="tool-btn" id="handTool" type="button" data-title="toolbar.move" aria-pressed="false">
                    <span data-text="toolbar.hand">РУКА</span>
                </button>
                <button class="tool-btn" id="connectTool" type="button" data-title="toolbar.connect" aria-pressed="false">
                    <span data-text="toolbar.connect">З'ЄДНАТИ</span>
                </button>
            </div>
            <div class="toolbar-right">
                <!-- Ecosystem Menu -->
                <div class="ecosystem-dropdown">
                    <button class="tool-btn" id="ecosystemBtn" type="button" data-title="toolbar.ecosystem" aria-haspopup="true" aria-expanded="false">
                        <span data-text="toolbar.ecosystem"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;vertical-align:middle"><circle cx="12" cy="12" r="3"/></svg>ЕКОСИСТЕМА</span>
                    </button>
                    <div class="ecosystem-menu" id="ecosystemMenu" role="menu">
                        <div class="ecosystem-menu-header" data-text="ecosystem.header">Системи TALKO</div>
                        <a href="https://alextalko.com/business-architecture-ua" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.architecture.title">Архітектура бізнесу</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.architecture.desc">Фундамент системи</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/kpi" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.kpi.title">Система статистик</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.kpi.desc">Контроль показників</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/alta" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.taskmanager.title">Таск менеджер</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.taskmanager.desc">Управління задачами</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/hiring-and-team-building-system" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.hiring.title">Система найму</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.hiring.desc">Команда на автопілоті</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/financecourse" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-5a3 3 0 0 0 0 6h2a3 3 0 0 1 0 6H8"/><line x1="12" y1="6" x2="12" y2="8"/><line x1="12" y1="18" x2="12" y2="20"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.finance.title">Система фінансів</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.finance.desc">Прозорість грошей</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/learning-platform-marketing-and-sales-system" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.marketing.title">Система маркетингу і продажів</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.marketing.desc">Передбачувані продажі</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/delegation-platform" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.delegation.title">Система делегування</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.delegation.desc">Передача задач команді</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/atm" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.strategy.title">Стратегічне планування</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.strategy.desc">Довгострокові цілі</div>
                            </div>
                        </a>
                        <a href="https://management-failure-log.vercel.app/" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.failurelog.title">Журнал управлінських збоїв</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.failurelog.desc">Аналіз помилок та рішень</div>
                            </div>
                        </a>
                        <a href="https://alextalko.com/algoritm" target="_blank" rel="noopener noreferrer" class="ecosystem-menu-item" role="menuitem">
                            <div class="ecosystem-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
                            <div class="ecosystem-item-content">
                                <div class="ecosystem-item-title" data-text="ecosystem.steps.title">Кроки систематизації</div>
                                <div class="ecosystem-item-desc" data-text="ecosystem.steps.desc">Алгоритм впровадження</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Support Dropdown -->
                <div class="support-dropdown">
                    <button class="tool-btn support-btn" id="supportBtn" type="button" data-title="toolbar.support" aria-haspopup="true" aria-expanded="false">
                        <span data-text="toolbar.support"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>ПІДТРИМКА 24/7</span>
                    </button>
                    <div class="support-menu" id="supportMenu" role="menu">
                        <a href="https://chatgpt.com/g/g-6870bc9f1658819192171561f5d8fe53-ai-konsultant-platformi-talko-management-system" target="_blank" rel="noopener noreferrer" class="support-menu-item" role="menuitem">
                            <div class="support-icon ai"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="8" cy="14" r="2"/><circle cx="16" cy="14" r="2"/></svg></div>
                            <div class="support-item-content">
                                <div class="support-item-title">AI Консультант</div>
                                <div class="support-item-desc">Допомога з налаштуваннями</div>
                            </div>
                        </a>
                        <a href="https://t.me/AlexEduPro_bot?start=68f4ac956d0d3141970a83e8" target="_blank" rel="noopener noreferrer" class="support-menu-item" role="menuitem">
                            <div class="support-icon telegram"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></div>
                            <div class="support-item-content">
                                <div class="support-item-title">Технічна підтримка</div>
                                <div class="support-item-desc">Telegram бот</div>
                            </div>
                        </a>
                        <div class="support-menu-divider"></div>
                        <div class="support-menu-item" id="backupRestoreBtn" role="menuitem" style="cursor:pointer;">
                            <div class="support-icon backup"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg></div>
                            <div class="support-item-content">
                                <div class="support-item-title" data-text="backup.restore">Відновити з backup</div>
                                <div class="support-item-desc" data-text="backup.restore_desc">Попередні версії структури</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Dropdown -->
                <div class="export-dropdown">
                    <button class="tool-btn" id="exportBtn" type="button" data-title="toolbar.export" aria-haspopup="true" aria-expanded="false">
                        <span data-text="toolbar.export">↓ ЕКСПОРТ</span>
                    </button>
                    <div class="export-menu" id="exportMenu" role="menu">
                        <div class="export-menu-item" id="exportJpegBtn" role="menuitem" tabindex="0">
                            <span class="export-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></span>
                            <span data-text="export.jpeg">Зберегти як JPEG</span>
                        </div>
                        <div class="export-menu-item" id="exportPdfBtn" role="menuitem" tabindex="0">
                            <span class="export-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>
                            <span data-text="export.pdf">Зберегти як PDF</span>
                        </div>
                        <div class="export-menu-item" id="exportExcelBtn" role="menuitem" tabindex="0">
                            <span class="export-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg></span>
                            <span data-text="export.excel">Зберегти як Excel</span>
                        </div>
                    </div>
                </div>

                <button class="tool-btn" id="copyBtn" type="button" data-title="toolbar.copy">
                    <span data-text="toolbar.copy">КОПІЮВАТИ</span>
                </button>
                <button class="tool-btn" id="pasteBtn" type="button" data-title="toolbar.paste">
                    <span data-text="toolbar.paste">ВСТАВИТИ</span>
                </button>
                <button class="tool-btn" id="showAllBtn" type="button" data-title="toolbar.show_all">
                    <span data-text="toolbar.show_all">ПОКАЗАТИ ВСЕ</span>
                </button>
                <!-- AI Assistants Dropdown -->
                <div class="ai-dropdown">
                    <button class="tool-btn ai-btn" id="aiAssistantsBtn" type="button" title="AI Асистенти" aria-haspopup="true" aria-expanded="false">
                        <span class="ai-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                                <circle cx="8" cy="14" r="2"/>
                                <circle cx="16" cy="14" r="2"/>
                            </svg>
                        </span>
                        <span data-text="toolbar.ai_assistants">AI АСИСТЕНТИ</span>
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div class="ai-menu" id="aiMenu" role="menu">
                        <a href="https://chatgpt.com/g/g-684c0092653c81919f42552c12434fa7-function-description-generator" target="_blank" rel="noopener noreferrer" class="ai-menu-item" role="menuitem">
                            <div class="ai-menu-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                                    <circle cx="8" cy="14" r="2"/>
                                    <circle cx="16" cy="14" r="2"/>
                                </svg>
                            </div>
                            <div class="ai-menu-content">
                                <div class="ai-menu-title" data-text="ai.function">AI Опис функції</div>
                                <div class="ai-menu-desc" data-text="ai.function_desc">Створення описів для функцій</div>
                            </div>
                        </a>
                        <a href="https://chatgpt.com/g/g-693ec18df2c0819194f1c3de7404d6fe-talko-ai-business-process" target="_blank" rel="noopener noreferrer" class="ai-menu-item" role="menuitem">
                            <div class="ai-menu-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                            </div>
                            <div class="ai-menu-content">
                                <div class="ai-menu-title" data-text="ai.process">AI Опис процесу</div>
                                <div class="ai-menu-desc" data-text="ai.process_desc">Написання бізнес-процесів</div>
                            </div>
                        </a>
                        <a href="https://chatgpt.com/g/g-68584f3314848191b812f6c0abaaae9e-organizational-structure" target="_blank" rel="noopener noreferrer" class="ai-menu-item" role="menuitem">
                            <div class="ai-menu-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                                    <path d="M10 6.5h4M6.5 10v4M17.5 10v4M10 17.5h4"/>
                                </svg>
                            </div>
                            <div class="ai-menu-content">
                                <div class="ai-menu-title" data-text="ai.structure">AI Структура</div>
                                <div class="ai-menu-desc" data-text="ai.structure_desc">Розробка організаційної структури</div>
                            </div>
                        </a>
                        <a href="https://chatgpt.com/g/g-6948fe9852508191a8d0f9f912baa547-ai-asistent-dlia-stvorennia-politiki-kompanii" target="_blank" rel="noopener noreferrer" class="ai-menu-item" role="menuitem">
                            <div class="ai-menu-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                            </div>
                            <div class="ai-menu-content">
                                <div class="ai-menu-title" data-text="ai.policy">AI Опис політики / правил</div>
                                <div class="ai-menu-desc" data-text="ai.policy_desc">Створення політик та правил компанії</div>
                            </div>
                        </a>
                        <a href="https://chatgpt.com/g/g-685640bc592881918743da9332b83f31-ai-alex-talko-technical-lead" target="_blank" rel="noopener noreferrer" class="ai-menu-item" role="menuitem">
                            <div class="ai-menu-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                                    <rect x="9" y="3" width="6" height="4" rx="1"/>
                                    <path d="M9 12l2 2 4-4"/>
                                </svg>
                            </div>
                            <div class="ai-menu-content">
                                <div class="ai-menu-title" data-text="ai.instruction">AI Опис інструкції</div>
                                <div class="ai-menu-desc" data-text="ai.instruction_desc">Як виконувати інструкцію крок за кроком</div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="logout-btn" id="logoutBtn" type="button" data-title="toolbar.logout" data-text="toolbar.logout">Вийти</button>
                </div>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <div class="canvas" id="canvas">
                <svg id="connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;" aria-hidden="true">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4299e1" />
                        </marker>
                    </defs>
                </svg>

                <div class="empty-state" id="emptyState">
                    <h3 data-text="empty.title">Створіть бізнес-систему</h3>
                    <p data-text="empty.subtitle">Почніть з головної функції, яка принесе вам свободу</p>
                    <button class="add-first-btn" id="addFirstBtn" type="button" data-text="empty.button">+ Додати першу функцію</button>
                </div>
            </div>
        </div>

        <!-- Mobile FAB Button -->
        <button class="mobile-fab" id="mobileFab" aria-label="Додати функцію">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>

        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomInBtn" type="button" data-title="zoom.in" aria-label="Збільшити">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </button>
            <div class="zoom-level" id="zoomLevel">100%</div>
            <button class="zoom-btn" id="zoomOutBtn" type="button" data-title="zoom.out" aria-label="Зменшити">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </button>
        </div>
    </div>

    <!-- Modal додавання/редагування -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" data-text="modal.add_function">Додати функцію</h2>
            </div>
            <div class="modal-body">
                <form id="functionForm" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="functionName" data-text="modal.function_name">Назва функції *</label>
                        <input type="text" class="form-input" id="functionName" required data-placeholder="modal.function_name_placeholder" placeholder="Наприклад: Маркетинг" maxlength="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="responsible" data-text="modal.responsible">Відповідальний *</label>
                        <input type="text" class="form-input" id="responsible" required data-placeholder="modal.responsible_placeholder" placeholder="Прізвище Ім'я" maxlength="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-text="modal.card_color">Колір карточки</label>
                        <div class="color-picker" id="colorPicker" role="radiogroup" aria-label="Вибір кольору">
                            <div class="color-option default selected" data-color="default" role="radio" aria-checked="true" tabindex="0"></div>
                            <div class="color-option blue" data-color="blue" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option green" data-color="green" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option purple" data-color="purple" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option red" data-color="red" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option orange" data-color="orange" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option teal" data-color="teal" role="radio" aria-checked="false" tabindex="-1"></div>
                            <div class="color-option pink" data-color="pink" role="radio" aria-checked="false" tabindex="-1"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="descriptionLink" data-text="modal.description_link">Посилання на опис функції</label>
                        <input type="url" class="form-input" id="descriptionLink" data-placeholder="modal.link_placeholder" placeholder="https://..." maxlength="500">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="kpi" data-text="modal.kpi">ЦКП (Цінний кінцевий продукт)</label>
                        <input type="text" class="form-input" id="kpi" data-placeholder="modal.kpi_placeholder" placeholder="Наприклад: Підписані договори, Готові відео, Нові клієнти" maxlength="200">
                    </div>

                    <div class="stats-form-group">
                        <label class="form-label" data-text="modal.statistics">Статистика</label>
                        <div id="statsContainer" role="list">
                            <!-- Статистичні поля будуть додані тут динамічно -->
                        </div>
                        <button type="button" class="add-stat-btn" id="addStatBtn" data-text="modal.add_metric">+ Додати метрику</button>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 5px; display: block;" data-text="modal.stats_hint">
                            Перетягуйте поля для зміни порядку. Клікайте на кольори для зміни оформлення.
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-text="modal.employees">Співробітники</label>
                        <div class="employees-input" id="employeesInput" role="list">
                            <!-- Співробітники будуть додані тут динамічно -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn" type="button" data-text="modal.cancel">Скасувати</button>
                <button class="btn btn-primary" id="saveBtn" type="button" data-text="modal.save">Зберегти</button>
            </div>
        </div>
    </div>

    <!-- Modal підтвердження видалення -->
    <div id="confirmModal" class="confirm-modal" role="alertdialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmDesc">
        <div class="confirm-content">
            <div class="confirm-header">
                <h3 id="confirmTitle" data-text="confirm.title">[!] Підтвердження видалення</h3>
            </div>
            <div class="confirm-body" id="confirmDesc">
                <p data-text="confirm.message">Ви дійсно хочете видалити функцію <strong id="deleteFunctionName"></strong>?</p>
                <p style="margin-top: 12px; font-size: 14px; color: var(--gray-500);" data-text="confirm.warning">
                    Це також видалить всі зв'язки з цією функцією. Дію неможливо скасувати.
                </p>
            </div>
            <div class="confirm-footer">
                <button class="btn btn-secondary" id="confirmCancelBtn" type="button" data-text="confirm.cancel">Скасувати</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" type="button" data-text="confirm.delete">Видалити</button>
            </div>
        </div>
    </div>

    <!-- Modal відновлення з backup -->
    <div id="backupModal" class="modal backup-modal" role="dialog" aria-modal="true" aria-labelledby="backupModalTitle">
        <div class="modal-content backup-modal-content">
            <div class="modal-header">
                <h2 id="backupModalTitle" data-text="backup.modal_title">🔄 Відновлення з backup</h2>
            </div>
            <div class="modal-body">
                <p class="backup-warning" data-text="backup.warning">
                    ⚠️ Увага: відновлення замінить поточну структуру на обрану версію!
                </p>
                <div class="backup-list-container">
                    <div id="backupList" class="backup-list">
                        <div class="backup-loading" data-text="backup.loading">Завантаження списку backup...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="backupCancelBtn" type="button" data-text="modal.cancel">Скасувати</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// TALKO SYSTEM v3.3 - BLOCK 2: FIREBASE + CORE LOGIC (FIXED)
// ============================================================================

(function() {
    'use strict';

    // === FIREBASE CONFIGURATION ===
    const firebaseConfig = {
        apiKey: "AIzaSyCHYakidP7B9eN8nU1oUjEFrIwreiDc_2Y",
        authDomain: "org-structure-42ee6.firebaseapp.com",
        projectId: "org-structure-42ee6",
        storageBucket: "org-structure-42ee6.firebasestorage.app",
        messagingSenderId: "647260349820",
        appId: "1:647260349820:web:56e3262a74738a49ae30f9",
        measurementId: "G-36FM8TRZSX"
    };

    // Ініціалізація Firebase (тільки якщо ще не ініціалізовано)
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Налаштування Firestore для офлайн режиму
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        if (err.code === 'failed-precondition') {
            console.warn('Firestore persistence: Multiple tabs open');
        } else if (err.code === 'unimplemented') {
            console.warn('Firestore persistence: Browser not supported');
        }
    });

    // === GLOBAL STATE (приватний) ===
    const State = {
        functions: [],
        connections: [],
        currentUser: null,
        structureListener: null,
        isLocalUpdate: false,
        isSaving: false,
        lastLocalSaveTime: 0,
        dataVersion: 0,
        hasPendingChanges: false,
        isOnline: navigator.onLine,
        connectionCheckInterval: null,
        retryAttempts: 0,
        MAX_RETRY_ATTEMPTS: 5,
        
        // UI State
        editingIndex: -1,
        deletingIndex: -1,
        currentEmployees: [],
        currentStats: [],
        selectedColor: 'default',
        currentTool: 'select',
        scale: 1,
        panX: 0,
        panY: 0,
        isPanning: false,
        lastPanPoint: null,
        parentFunction: null,
        connectingFrom: null,
        currentLanguage: 'uk'
    };

    // === CONSTANTS ===
    const PERFORMANCE = {
        SAVE_INTERVAL: 2000,
        ANIMATION_DURATION: 200,
        RENDER_DEBOUNCE: 16 // ~60fps
    };

    const STAT_COLORS = ['blue', 'green', 'red', 'yellow', 'purple', 'orange', 'teal', 'pink', 'gray'];

    // === TRANSLATIONS ===
    const translations = {
        uk: {
            'login.title': 'TALKO System',
            'login.subtitle': 'Звільняє власника. Масштабує бізнес. Керує замість вас.',
            'login.description': 'Це не просто "менеджмент", а система, що вивільняє час і ростить компанію',
            'login.email': 'Email',
            'login.password': 'Пароль',
            'login.button': 'Увійти',
            'login.loading': 'Підключення...',
            'login.error.user_not_found': 'Користувача не знайдено',
            'login.error.wrong_password': 'Невірний пароль',
            'login.error.invalid_email': 'Невірний формат email',
            'login.error.too_many_requests': 'Забагато спроб. Спробуйте пізніше',
            'login.error.default': 'Помилка авторизації',
            'toolbar.add': '+ ДОДАТИ',
            'toolbar.select': 'ВИБІР',
            'toolbar.hand': 'РУКА',
            'toolbar.connect': 'З\'ЄДНАТИ',
            'toolbar.ecosystem': 'ЕКОСИСТЕМА',
            'toolbar.support': 'ПІДТРИМКА 24/7',
            'toolbar.copy': 'КОПІЮВАТИ',
            'toolbar.paste': 'ВСТАВИТИ',
            'toolbar.show_all': 'ПОКАЗАТИ ВСЕ',
            'toolbar.ai_assistants': 'AI АСИСТЕНТИ',
            'toolbar.logout': 'Вийти',
            'toolbar.sync': 'СИНХРОНІЗУВАТИ',
            'toolbar.export': '↓ ЕКСПОРТ',
            'toolbar.add_function': 'Додати нову функцію',
            'toolbar.move': 'Переміщення',
            'export.jpeg': 'Зберегти як JPEG',
            'export.pdf': 'Зберегти як PDF',
            'export.excel': 'Зберегти як Excel',
            'export.preparing': 'Створення експорту...',
            'export.success_jpeg': 'JPEG збережено!',
            'export.success_pdf': 'PDF збережено з активними посиланнями!',
            'export.error': 'Помилка експорту',
            'export.active_links': 'активних посилань',
            'export.links_section': 'ПОСИЛАННЯ НА СИСТЕМИ:',
            'ai.function': 'AI Опис функції',
            'ai.function_desc': 'Створення описів для функцій',
            'ai.process': 'AI Опис процесу',
            'ai.process_desc': 'Написання бізнес-процесів',
            'ai.structure': 'AI Структура',
            'ai.structure_desc': 'Розробка організаційної структури',
            'ai.policy': 'AI Опис політики / правил',
            'ai.policy_desc': 'Створення політик та правил компанії',
            'ai.instruction': 'AI Опис інструкції',
            'ai.instruction_desc': 'Як виконувати інструкцію крок за кроком',
            'backup.restore': 'Відновити з backup',
            'backup.restore_desc': 'Попередні версії структури',
            'backup.modal_title': '🔄 Відновлення з backup',
            'backup.warning': '⚠️ Увага: відновлення замінить поточну структуру на обрану версію!',
            'backup.loading': 'Завантаження списку backup...',
            'ecosystem.header': 'Системи TALKO',
            'ecosystem.architecture.title': 'Архітектура бізнесу',
            'ecosystem.architecture.desc': 'Фундамент системи',
            'ecosystem.finance.title': 'Система фінансів',
            'ecosystem.finance.desc': 'Прозорість грошей',
            'ecosystem.hiring.title': 'Система найму',
            'ecosystem.hiring.desc': 'Команда на автопілоті',
            'ecosystem.marketing.title': 'Система маркетингу і продажів',
            'ecosystem.marketing.desc': 'Передбачувані продажі',
            'ecosystem.kpi.title': 'Система статистик',
            'ecosystem.kpi.desc': 'Контроль показників',
            'ecosystem.taskmanager.title': 'Таск менеджер',
            'ecosystem.taskmanager.desc': 'Управління задачами',
            'ecosystem.delegation.title': 'Система делегування',
            'ecosystem.delegation.desc': 'Передача задач команді',
            'ecosystem.strategy.title': 'Стратегічне планування',
            'ecosystem.strategy.desc': 'Довгострокові цілі',
            'ecosystem.failurelog.title': 'Журнал управлінських збоїв',
            'ecosystem.failurelog.desc': 'Аналіз помилок та рішень',
            'ecosystem.steps.title': 'Кроки систематизації',
            'ecosystem.steps.desc': 'Алгоритм впровадження',
            'empty.title': 'Створіть бізнес-систему',
            'empty.subtitle': 'Почніть з головної функції, яка принесе вам свободу',
            'empty.button': '+ Додати першу функцію',
            'modal.add_function': 'Додати функцію',
            'modal.edit_function': 'Редагувати функцію',
            'modal.add_subfunction': 'Додати підфункцію',
            'modal.function_name': 'Назва функції *',
            'modal.function_name_placeholder': 'Наприклад: Маркетинг',
            'modal.responsible': 'Відповідальний *',
            'modal.responsible_placeholder': 'Прізвище Ім\'я',
            'modal.card_color': 'Колір карточки',
            'modal.description_link': 'Посилання на опис функції',
            'modal.link_placeholder': 'https://...',
            'modal.kpi': 'ЦКП (Цінний кінцевий продукт)',
            'modal.kpi_placeholder': 'Наприклад: Підписані договори',
            'modal.statistics': 'Статистика',
            'modal.add_metric': '+ Додати метрику',
            'modal.stats_hint': 'Перетягуйте поля для зміни порядку',
            'modal.employees': 'Співробітники',
            'modal.employees_placeholder': 'Введіть ім\'я та натисніть Enter',
            'modal.cancel': 'Скасувати',
            'modal.save': 'Зберегти',
            'modal.required_fields': 'Заповніть обов\'язкові поля',
            'modal.paste_structure': 'Вставити структуру',
            'modal.found': 'Знайдено',
            'modal.functions': 'функцій',
            'modal.exported_by': 'Експортовано',
            'modal.current_functions': 'Поточних функцій',
            'modal.add_to_existing': 'Додати до існуючих',
            'modal.replace_all': 'Замінити всі',
            'modal.auto_arrange': 'Функції будуть розташовані автоматично',
            'modal.paste': 'Вставити',
            'confirm.title': '[!] Підтвердження видалення',
            'confirm.message': 'Ви дійсно хочете видалити функцію',
            'confirm.warning': 'Це також видалить всі зв\'язки. Дію неможливо скасувати.',
            'confirm.cancel': 'Скасувати',
            'confirm.delete': 'Видалити',
            'zoom.in': 'Збільшити',
            'zoom.out': 'Зменшити',
            'notification.structure_copied': 'Структуру скопійовано!',
            'notification.copy_error': 'Помилка копіювання',
            'notification.clipboard_empty': 'Буфер обміну порожній',
            'notification.invalid_format': 'Невірний формат даних',
            'notification.no_functions': 'Немає функцій для вставки',
            'notification.parse_error': 'Помилка читання даних',
            'notification.clipboard_error': 'Помилка доступу до буфера',
            'notification.paste_not_supported': 'Вставка не підтримується',
            'notification.no_functions_to_copy': 'Немає функцій для копіювання',
            'notification.functions_pasted': 'Вставлено функцій:',
            'notification.data_synced': 'Дані синхронізовано',
            'notification.sync_error': 'Помилка синхронізації',
            'notification.connection_lost': 'З\'єднання втрачено',
            'notification.connection_restored': 'З\'єднання відновлено',
            'notification.sync_in_progress': 'Синхронізація...',
            'notification.saving': 'Збереження...',
            'notification.saved': 'Збережено',
            'field.kpi': 'ЦКП',
            'field.description': 'Опис функції',
            'field.view_instruction': 'Переглянути інструкцію',
            'field.employees': 'Співробітники',
            'card.edit': 'ЗМІН',
            'card.delete': 'ВИД',
            'card.edit_tooltip': 'Редагувати',
            'card.delete_tooltip': 'Видалити',
            'card.add_subfunction': 'Додати підфункцію',
            'prompt.logout': 'Ви дійсно хочете вийти?',
            'prompt.delete_connection': 'Видалити зв\'язок між "%s" та "%s"?',
            'lang.uk': 'УКР',
            'lang.ru': 'РУС',
            'lang.en': 'ENG',
            'lang.bg': 'БГ',
            'loading.data': 'Завантаження даних...',
            'loading.syncing': 'Синхронізація...'
        },
        
        ru: {
            'login.title': 'TALKO System',
            'login.subtitle': 'Освобождает владельца. Масштабирует бизнес.',
            'login.description': 'Система, которая освобождает время и растит компанию',
            'login.email': 'Email',
            'login.password': 'Пароль',
            'login.button': 'Войти',
            'login.loading': 'Подключение...',
            'login.error.user_not_found': 'Пользователь не найден',
            'login.error.wrong_password': 'Неверный пароль',
            'login.error.invalid_email': 'Неверный формат email',
            'login.error.too_many_requests': 'Слишком много попыток',
            'login.error.default': 'Ошибка авторизации',
            'toolbar.add': '+ ДОБАВИТЬ',
            'toolbar.select': 'ВЫБОР',
            'toolbar.hand': 'РУКА',
            'toolbar.connect': 'СВЯЗАТЬ',
            'toolbar.ecosystem': 'ЭКОСИСТЕМА',
            'toolbar.support': 'ПОДДЕРЖКА 24/7',
            'toolbar.copy': 'КОПИРОВАТЬ',
            'toolbar.paste': 'ВСТАВИТЬ',
            'toolbar.show_all': 'ПОКАЗАТЬ ВСЁ',
            'toolbar.ai_assistants': 'AI АССИСТЕНТЫ',
            'toolbar.logout': 'Выйти',
            'toolbar.sync': 'СИНХРОНИЗИРОВАТЬ',
            'toolbar.export': '↓ ЭКСПОРТ',
            'export.jpeg': 'Сохранить как JPEG',
            'export.pdf': 'Сохранить как PDF',
            'export.excel': 'Сохранить как Excel',
            'ai.function': 'AI Описание функции',
            'ai.function_desc': 'Создание описаний для функций',
            'ai.process': 'AI Описание процесса',
            'ai.process_desc': 'Написание бизнес-процессов',
            'ai.structure': 'AI Структура',
            'ai.structure_desc': 'Разработка организационной структуры',
            'ai.policy': 'AI Описание политики / правил',
            'ai.policy_desc': 'Создание политик и правил компании',
            'ai.instruction': 'AI Описание инструкции',
            'ai.instruction_desc': 'Как выполнять инструкцию пошагово',
            'backup.restore': 'Восстановить из backup',
            'backup.restore_desc': 'Предыдущие версии структуры',
            'backup.modal_title': '🔄 Восстановление из backup',
            'backup.warning': '⚠️ Внимание: восстановление заменит текущую структуру на выбранную версию!',
            'backup.loading': 'Загрузка списка backup...',
            'ecosystem.header': 'Системы TALKO',
            'empty.title': 'Создайте бизнес-систему',
            'empty.subtitle': 'Начните с главной функции',
            'empty.button': '+ Добавить первую функцию',
            'modal.add_function': 'Добавить функцию',
            'modal.edit_function': 'Редактировать функцию',
            'modal.function_name': 'Название функции *',
            'modal.responsible': 'Ответственный *',
            'modal.cancel': 'Отмена',
            'modal.save': 'Сохранить',
            'confirm.title': '[!] Подтверждение удаления',
            'confirm.message': 'Вы действительно хотите удалить функцию',
            'confirm.cancel': 'Отмена',
            'confirm.delete': 'Удалить',
            'notification.data_synced': 'Данные синхронизированы',
            'notification.sync_error': 'Ошибка синхронизации',
            'ecosystem.delegation.title': 'Система делегирования',
            'ecosystem.delegation.desc': 'Передача задач команде',
            'ecosystem.strategy.title': 'Стратегическое планирование',
            'ecosystem.strategy.desc': 'Долгосрочные цели',
            'ecosystem.failurelog.title': 'Журнал управленческих сбоев',
            'ecosystem.failurelog.desc': 'Анализ ошибок и решений',
            'ecosystem.steps.title': 'Шаги систематизации',
            'ecosystem.steps.desc': 'Алгоритм внедрения',
            'lang.uk': 'УКР',
            'lang.ru': 'РУС',
            'lang.en': 'ENG',
            'lang.bg': 'БГ'
        },
        
        en: {
            'login.title': 'TALKO System',
            'login.subtitle': 'Frees the owner. Scales the business.',
            'login.description': 'A system that frees time and grows the company',
            'login.email': 'Email',
            'login.password': 'Password',
            'login.button': 'Sign In',
            'login.loading': 'Connecting...',
            'login.error.user_not_found': 'User not found',
            'login.error.wrong_password': 'Wrong password',
            'login.error.invalid_email': 'Invalid email format',
            'login.error.too_many_requests': 'Too many attempts',
            'login.error.default': 'Authentication error',
            'toolbar.add': '+ ADD',
            'toolbar.select': 'SELECT',
            'toolbar.hand': 'HAND',
            'toolbar.connect': 'CONNECT',
            'toolbar.ecosystem': 'ECOSYSTEM',
            'toolbar.support': 'SUPPORT 24/7',
            'toolbar.copy': 'COPY',
            'toolbar.paste': 'PASTE',
            'toolbar.show_all': 'SHOW ALL',
            'toolbar.ai_assistants': 'AI ASSISTANTS',
            'toolbar.logout': 'Logout',
            'toolbar.sync': 'SYNC',
            'toolbar.export': '↓ EXPORT',
            'export.jpeg': 'Save as JPEG',
            'export.pdf': 'Save as PDF',
            'export.excel': 'Save as Excel',
            'ai.function': 'AI Function Description',
            'ai.function_desc': 'Create descriptions for functions',
            'ai.process': 'AI Process Description',
            'ai.process_desc': 'Write business processes',
            'ai.structure': 'AI Structure',
            'ai.structure_desc': 'Develop organizational structure',
            'ai.policy': 'AI Policy / Rules Description',
            'ai.policy_desc': 'Create company policies and rules',
            'ai.instruction': 'AI Instruction Description',
            'ai.instruction_desc': 'How to execute instructions step by step',
            'backup.restore': 'Restore from backup',
            'backup.restore_desc': 'Previous structure versions',
            'backup.modal_title': '🔄 Restore from backup',
            'backup.warning': '⚠️ Warning: restore will replace current structure with selected version!',
            'backup.loading': 'Loading backup list...',
            'ecosystem.header': 'TALKO Systems',
            'empty.title': 'Create business system',
            'empty.subtitle': 'Start with the main function',
            'empty.button': '+ Add first function',
            'modal.add_function': 'Add function',
            'modal.edit_function': 'Edit function',
            'modal.function_name': 'Function name *',
            'modal.responsible': 'Responsible *',
            'modal.cancel': 'Cancel',
            'modal.save': 'Save',
            'confirm.title': '[!] Delete confirmation',
            'confirm.message': 'Do you really want to delete function',
            'confirm.cancel': 'Cancel',
            'confirm.delete': 'Delete',
            'notification.data_synced': 'Data synced',
            'notification.sync_error': 'Sync error',
            'ecosystem.delegation.title': 'Delegation System',
            'ecosystem.delegation.desc': 'Task transfer to team',
            'ecosystem.strategy.title': 'Strategic Planning',
            'ecosystem.strategy.desc': 'Long-term goals',
            'ecosystem.failurelog.title': 'Management Failure Log',
            'ecosystem.failurelog.desc': 'Error analysis and solutions',
            'ecosystem.steps.title': 'Systematization Steps',
            'ecosystem.steps.desc': 'Implementation algorithm',
            'lang.uk': 'UKR',
            'lang.ru': 'RUS',
            'lang.en': 'ENG',
            'lang.bg': 'BG'
        },
        
        bg: {
            'login.title': 'TALKO System',
            'login.subtitle': 'Освобождава собственика. Мащабира бизнеса.',
            'login.email': 'Email',
            'login.password': 'Парола',
            'login.button': 'Влез',
            'toolbar.add': '+ ДОБАВИ',
            'toolbar.select': 'ИЗБОР',
            'toolbar.hand': 'РЪКА',
            'toolbar.connect': 'СВЪРЖИ',
            'toolbar.ecosystem': 'ЕКОСИСТЕМА',
            'toolbar.logout': 'Изход',
            'toolbar.sync': 'СИНХРОНИЗИРАЙ',
            'modal.add_function': 'Добави функция',
            'modal.cancel': 'Отказ',
            'modal.save': 'Запази',
            'confirm.title': '[!] Потвърждение за изтриване',
            'confirm.cancel': 'Отказ',
            'confirm.delete': 'Изтрий',
            'ecosystem.delegation.title': 'Система за делегиране',
            'ecosystem.delegation.desc': 'Предаване на задачи на екипа',
            'ecosystem.strategy.title': 'Стратегическо планиране',
            'ecosystem.strategy.desc': 'Дългосрочни цели',
            'ecosystem.failurelog.title': 'Дневник на управленски грешки',
            'ecosystem.failurelog.desc': 'Анализ на грешки и решения',
            'ecosystem.steps.title': 'Стъпки за систематизация',
            'ecosystem.steps.desc': 'Алгоритъм за внедряване',
            'export.pdf': 'Запази като PDF',
            'export.excel': 'Запази като Excel',
            'backup.restore': 'Възстанови от backup',
            'backup.restore_desc': 'Предишни версии на структурата',
            'backup.modal_title': '🔄 Възстановяване от backup',
            'backup.warning': '⚠️ Внимание: възстановяването ще замени текущата структура с избраната версия!',
            'backup.loading': 'Зареждане на списъка с backup...',
            'lang.uk': 'УКР',
            'lang.ru': 'РУС',
            'lang.en': 'ENG',
            'lang.bg': 'БГ'
        }
    };

    // === UTILITY FUNCTIONS ===
    const Utils = {
        generateId: () => Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        
        formatDate: (date = new Date()) => {
            return date.toISOString().split('T')[0];
        },
        
        debounce: (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },
        
        throttle: (func, limit) => {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        },
        
        // XSS Protection - sanitize user input
        escapeHtml: (text) => {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        // Validate URL
        isValidUrl: (string) => {
            if (!string) return true; // Empty is OK
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        },
        
        // Safe DOM element getter
        getElement: (id) => document.getElementById(id),
        
        // Safe query selector
        query: (selector) => document.querySelector(selector),
        
        // Safe query all
        queryAll: (selector) => document.querySelectorAll(selector)
    };

    // === TRANSLATION FUNCTION ===
    function t(key, ...args) {
        let text = translations[State.currentLanguage]?.[key] 
                || translations.uk[key] 
                || key;
        
        if (args.length > 0) {
            args.forEach((arg) => {
                text = text.replace('%s', Utils.escapeHtml(String(arg)));
            });
        }
        return text;
    }

    // === LANGUAGE SYSTEM ===
    function loadLanguage() {
        const saved = localStorage.getItem('talko_language');
        if (saved && translations[saved]) {
            State.currentLanguage = saved;
        }
        updateLanguageInterface();
    }

    function changeLanguage(lang) {
        if (translations[lang]) {
            State.currentLanguage = lang;
            localStorage.setItem('talko_language', lang);
            updateLanguageInterface();
            
            const options = Utils.getElement('languageOptions');
            if (options) options.classList.remove('show');
            
            document.documentElement.lang = lang;
            
            // Re-render if functions exist
            if (typeof window.renderFunctions === 'function') {
                window.renderFunctions();
            }
        }
    }

    function updateLanguageInterface() {
        const flagElement = Utils.getElement('currentLanguageFlag');
        const nameElement = Utils.getElement('currentLanguageName');
        
        if (flagElement) flagElement.className = `language-flag flag-${State.currentLanguage}`;
        if (nameElement) nameElement.textContent = t(`lang.${State.currentLanguage}`);
        
        Utils.queryAll('.language-option').forEach(option => {
            option.classList.toggle('active', option.dataset.lang === State.currentLanguage);
        });
        
        Utils.queryAll('[data-text]').forEach(element => {
            const key = element.getAttribute('data-text');
            element.textContent = t(key);
        });
        
        Utils.queryAll('[data-placeholder]').forEach(element => {
            const key = element.getAttribute('data-placeholder');
            element.placeholder = t(key);
        });
        
        Utils.queryAll('[data-title]').forEach(element => {
            const key = element.getAttribute('data-title');
            element.title = t(key);
        });
    }

    // === NOTIFICATION SYSTEM ===
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        Utils.queryAll('.notification-toast').forEach(n => n.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification-toast ${type}`;
        notification.textContent = message;
        notification.setAttribute('role', 'alert');
        notification.setAttribute('aria-live', 'polite');
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('hiding');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // === LOADING OVERLAY ===
    let loadingTimeout = null;
    
    function showLoading(message = 'Завантаження...') {
        const overlay = Utils.getElement('loadingOverlay');
        const text = Utils.getElement('loadingText');
        if (overlay) {
            if (text) text.textContent = message;
            overlay.classList.add('show');
            
            // Автоматично приховуємо через 30 секунд (захист від зависання)
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
                console.warn('[WARN] Loading timeout - примусово приховано');
                showNotification('Завантаження тривало надто довго. Спробуйте оновити сторінку.', 'error');
            }, 30000);
        }
    }

    function hideLoading() {
        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
            loadingTimeout = null;
        }
        const overlay = Utils.getElement('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }

    // === CONNECTION STATUS ===
    function updateConnectionStatus(status, text) {
        const statusEl = Utils.getElement('connectionStatus');
        const textEl = Utils.getElement('connectionText');
        
        if (statusEl && textEl) {
            statusEl.className = `connection-status show ${status}`;
            textEl.textContent = text;
            
            // Auto-hide after 3 seconds for non-error states
            if (status !== 'offline' && status !== 'syncing') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }
    }

    // === AUTHENTICATION ===
    function showLogin() {
        const loginScreen = Utils.getElement('loginScreen');
        const appContainer = Utils.getElement('appContainer');
        if (loginScreen) loginScreen.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';
    }

    function hideLogin() {
        const loginScreen = Utils.getElement('loginScreen');
        const appContainer = Utils.getElement('appContainer');
        if (loginScreen) loginScreen.style.display = 'none';
        if (appContainer) appContainer.style.display = 'block';
    }

    function showLoginError(message) {
        const errorDiv = Utils.getElement('loginError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }
    }

    function showLoginLoading(show) {
        const btn = Utils.getElement('loginBtn');
        if (btn) {
            btn.disabled = show;
            btn.classList.toggle('loading', show);
        }
    }

    function logout() {
        // Use custom modal instead of confirm
        if (confirm(t('prompt.logout'))) {
            cleanupListeners();
            auth.signOut();
        }
    }

    function cleanupListeners() {
        if (State.structureListener) {
            State.structureListener();
            State.structureListener = null;
        }
        if (State.connectionCheckInterval) {
            clearInterval(State.connectionCheckInterval);
            State.connectionCheckInterval = null;
        }
        // Remove online/offline listeners to prevent memory leaks
        window.removeEventListener('online', handleOnlineStatus);
        window.removeEventListener('offline', handleOfflineStatus);
    }

    // === CONNECTION MONITORING ===
    function startConnectionMonitoring() {
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOfflineStatus);
        State.connectionCheckInterval = setInterval(checkFirebaseConnection, 30000);
        checkFirebaseConnection();
    }

    function handleOnlineStatus() {
        State.isOnline = true;
        console.log('[OK] Інтернет з\'єднання відновлено');
        updateConnectionStatus('syncing', t('notification.connection_restored'));
        
        if (!State.currentUser) return;
        
        // Якщо є локальні дані - спочатку зберігаємо їх
        if (State.functions.length > 0 && State.hasPendingChanges) {
            console.log('[SYNC] Зберігаємо локальні зміни...');
            saveToFirestore();
        } 
        // Якщо немає даних - завантажуємо з сервера
        else if (State.functions.length === 0) {
            console.log('[SYNC] Завантажуємо дані з сервера...');
            loadFromFirestore();
        }
        // Інакше - просто перевіряємо синхронізацію
        else {
            setTimeout(() => {
                updateConnectionStatus('success', t('notification.connected'));
            }, 1000);
        }
    }

    function handleOfflineStatus() {
        State.isOnline = false;
        console.log('[ERR] Інтернет з\'єднання втрачено');
        updateConnectionStatus('offline', t('notification.connection_lost'));
    }

    function checkFirebaseConnection() {
        if (!State.currentUser || !State.isOnline) return;
        
        const testRef = db.collection('users').doc(State.currentUser.uid).collection('test').doc('ping');
        
        testRef.set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() })
            .then(() => {
                State.retryAttempts = 0;
                return testRef.delete();
            })
            .catch(error => {
                console.error('[ERR] Проблема з Firebase:', error);
                State.retryAttempts++;
                
                if (State.retryAttempts > State.MAX_RETRY_ATTEMPTS) {
                    updateConnectionStatus('offline', 'Проблеми з підключенням');
                    State.retryAttempts = 0;
                }
            });
    }

    // === FIRESTORE FUNCTIONS ===
    function loadFromFirestore() {
        if (!State.currentUser) return;
        
        console.log('[LOAD] Завантажуємо дані для:', State.currentUser.uid);
        showLoading(t('loading.data'));
        
        State.isLocalUpdate = true;
        State.hasPendingChanges = false;
        
        db.collection('users').doc(State.currentUser.uid).collection('main').doc('structure').get()
            .then(doc => {
                hideLoading();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Підтримка обох структур: data.functions АБО data.structure.functions
                    const functions = data.functions || (data.structure && data.structure.functions) || [];
                    const connections = data.connections || (data.structure && data.structure.connections) || [];
                    const language = data.language || data.Language || (data.structure && data.structure.Language);
                    
                    if (functions.length > 0) {
                        State.functions = functions.map(func => ({
                            ...func,
                            id: func.id || Utils.generateId(),
                            created: func.created || new Date().toISOString(),
                            modified: func.modified || func.created || new Date().toISOString()
                        }));
                        State.connections = connections;
                        State.dataVersion = data.version || 0;
                        
                        if (language && translations[language]) {
                            State.currentLanguage = language;
                            localStorage.setItem('talko_language', language);
                            updateLanguageInterface();
                        }
                        
                        console.log('[OK] Завантажено функцій:', State.functions.length);
                        
                        // Зберігаємо локальний backup
                        try {
                            localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify({
                                functions: State.functions,
                                connections: State.connections,
                                language: State.currentLanguage,
                                timestamp: Date.now()
                            }));
                        } catch (e) {}
                        
                        // Якщо була вкладена структура - нормалізуємо
                        if (data.structure && data.structure.functions && !data.functions) {
                            console.log('[FIX] Нормалізація структури...');
                            saveToFirestore();
                        }
                        
                        // Trigger render
                        if (typeof window.renderFunctions === 'function') {
                            window.renderFunctions();
                        }
                        
                        setTimeout(() => {
                            State.isLocalUpdate = false;
                            setupStructureListener();
                        }, 1000);
                        
                    } else {
                        // Спробуємо відновити з локального backup
                        console.log('[EMPTY] Структура не знайдена, перевіряємо локальний backup...');
                        const restored = tryRestoreFromLocalBackup();
                        if (!restored) {
                            State.functions = [];
                            State.connections = [];
                            if (typeof window.renderFunctions === 'function') {
                                window.renderFunctions();
                            }
                            setTimeout(() => {
                                State.isLocalUpdate = false;
                                setupStructureListener();
                            }, 1000);
                        }
                    }
                } else {
                    console.log('[EMPTY] Структура не знайдена, перевіряємо стару...');
                    const restored = tryRestoreFromLocalBackup();
                    if (!restored) {
                        migrateFromOldStructure();
                    }
                }
            })
            .catch(error => {
                hideLoading();
                console.error('[ERR] Помилка завантаження:', error);
                State.isLocalUpdate = false;
                
                // Спробуємо відновити з локального backup
                const restored = tryRestoreFromLocalBackup();
                if (!restored) {
                    showNotification(t('notification.sync_error'), 'error');
                }
                
                // Retry after delay
                setTimeout(() => {
                    if (State.currentUser && State.functions.length === 0) {
                        loadFromFirestore();
                    }
                }, 5000);
            });
    }

    function setupStructureListener() {
        if (!State.currentUser || State.structureListener) return;
        
        console.log('[LISTEN] Встановлюємо listener...');
        
        State.structureListener = db.collection('users').doc(State.currentUser.uid)
            .collection('main').doc('structure')
            .onSnapshot(doc => {
                if (State.isLocalUpdate || State.isSaving || State.hasPendingChanges) {
                    return;
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    const serverModified = new Date(data.lastModified || 0).getTime();
                    const localModified = State.lastLocalSaveTime || 0;
                    const timeDiff = serverModified - localModified;
                    
                    // Підтримка обох структур
                    const functions = data.functions || (data.structure && data.structure.functions) || [];
                    const connections = data.connections || (data.structure && data.structure.connections) || [];
                    
                    if (timeDiff > 5000 && functions.length > 0) {
                        // Захист від втрати даних - якщо сервер має менше функцій
                        if (functions.length < State.functions.length && State.functions.length > 0) {
                            console.warn('[WARN] Сервер має менше функцій ніж локально:', functions.length, 'vs', State.functions.length);
                            // Не перезаписуємо - можливо інша вкладка видалила дані
                            return;
                        }
                        
                        if (State.functions.length === 0 || functions.length >= State.functions.length) {
                            console.log('[LOAD] Застосовуємо серверні дані:', functions.length, 'функцій');
                            
                            State.functions = functions.map(func => ({
                                ...func,
                                id: func.id || Utils.generateId()
                            }));
                            State.connections = connections;
                            State.dataVersion = data.version || 0;
                            
                            // Оновлюємо локальний backup
                            try {
                                localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify({
                                    functions: State.functions,
                                    connections: State.connections,
                                    language: State.currentLanguage,
                                    timestamp: Date.now()
                                }));
                            } catch (e) {}
                            
                            if (typeof window.renderFunctions === 'function') {
                                window.renderFunctions();
                            }
                            showNotification(t('notification.data_synced'), 'success');
                        }
                    }
                }
            }, error => {
                console.error('[ERR] Помилка підписки:', error);
            });
    }

    function tryRestoreFromLocalBackup() {
        if (!State.currentUser) return false;
        
        try {
            const localBackup = localStorage.getItem('talko_local_backup_' + State.currentUser.uid);
            if (!localBackup) return false;
            
            const data = JSON.parse(localBackup);
            
            // Перевіряємо чи backup свіжий (не старший 7 днів)
            const backupAge = Date.now() - (data.timestamp || 0);
            const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 днів
            
            if (backupAge > maxAge) {
                console.log('[LOCAL] Локальний backup застарілий, ігноруємо');
                return false;
            }
            
            if (data.functions && data.functions.length > 0) {
                console.log('[LOCAL] Відновлюємо з локального backup:', data.functions.length, 'функцій');
                
                State.functions = data.functions;
                State.connections = data.connections || [];
                
                if (data.language && translations[data.language]) {
                    State.currentLanguage = data.language;
                    localStorage.setItem('talko_language', data.language);
                    updateLanguageInterface();
                }
                
                hideLoading();
                
                if (typeof window.renderFunctions === 'function') {
                    window.renderFunctions();
                }
                
                showNotification('Відновлено з локального backup', 'info');
                
                // Зберігаємо в Firebase
                setTimeout(() => {
                    saveToFirestore();
                    State.isLocalUpdate = false;
                    setupStructureListener();
                }, 2000);
                
                return true;
            }
        } catch (err) {
            console.error('[ERR] Помилка відновлення з локального backup:', err);
        }
        
        return false;
    }

    function migrateFromOldStructure() {
        db.collection('users').doc(State.currentUser.uid).get()
            .then(oldDoc => {
                hideLoading();
                
                if (oldDoc.exists && (oldDoc.data().functions || oldDoc.data().connections)) {
                    console.log('[MIGRATE] Міграція старих даних...');
                    
                    const oldData = oldDoc.data();
                    State.functions = oldData.functions || [];
                    State.connections = oldData.connections || [];
                    
                    if (oldData.language && translations[oldData.language]) {
                        State.currentLanguage = oldData.language;
                        localStorage.setItem('talko_language', oldData.language);
                        updateLanguageInterface();
                    }
                    
                    saveToFirestore().then(() => {
                        console.log('[OK] Міграція завершена');
                        if (typeof window.renderFunctions === 'function') {
                            window.renderFunctions();
                        }
                        
                        setTimeout(() => {
                            State.isLocalUpdate = false;
                            setupStructureListener();
                        }, 1000);
                    });
                    
                } else {
                    console.log('[USER] Новий користувач');
                    State.functions = [];
                    State.connections = [];
                    State.isLocalUpdate = false;
                    
                    if (typeof window.renderFunctions === 'function') {
                        window.renderFunctions();
                    }
                }
            })
            .catch(error => {
                hideLoading();
                console.error('[ERR] Помилка міграції:', error);
                State.isLocalUpdate = false;
                State.functions = [];
                State.connections = [];
                
                if (typeof window.renderFunctions === 'function') {
                    window.renderFunctions();
                }
            });
    }

    function saveToFirestore() {
        if (!State.currentUser) return Promise.resolve();
        
        // ЗАХИСТ: не зберігаємо порожні дані якщо раніше були функції
        if (State.functions.length === 0 && State.dataVersion > 1) {
            console.warn('[WARN] Спроба зберегти порожню структуру заблокована!');
            return Promise.resolve();
        }
        
        State.isLocalUpdate = true;
        State.isSaving = true;
        State.hasPendingChanges = false;
        State.lastLocalSaveTime = Date.now();
        State.dataVersion++;
        
        updateConnectionStatus('saving', t('notification.saving'));
        
        const data = {
            functions: State.functions,
            connections: State.connections,
            language: State.currentLanguage,
            version: State.dataVersion,
            lastModified: new Date().toISOString(),
            deviceId: navigator.userAgent.substring(0, 50),
            functionsCount: State.functions.length
        };
        
        console.log('[SAVE] Зберігаю структуру:', data.functions.length, 'функцій');
        
        return db.collection('users').doc(State.currentUser.uid)
            .collection('main').doc('structure').set(data)
            .then(() => {
                console.log('[OK] Збережено в Firestore');
                updateConnectionStatus('success', t('notification.saved'));
                
                // Оновлюємо локальний backup
                try {
                    localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify({
                        functions: State.functions,
                        connections: State.connections,
                        language: State.currentLanguage,
                        timestamp: Date.now()
                    }));
                } catch (e) {}
                
                setTimeout(() => {
                    State.isLocalUpdate = false;
                    State.isSaving = false;
                }, 2000);
            })
            .catch(error => {
                console.error('[ERR] Помилка збереження:', error);
                State.isLocalUpdate = false;
                State.isSaving = false;
                
                // Зберігаємо локально навіть при помилці Firebase
                try {
                    localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify({
                        functions: State.functions,
                        connections: State.connections,
                        language: State.currentLanguage,
                        timestamp: Date.now(),
                        pendingSync: true
                    }));
                    console.log('[LOCAL] Збережено локально, очікує синхронізації');
                } catch (e) {}
                
                updateConnectionStatus('error', t('notification.sync_error'));
                
                // Retry
                setTimeout(() => saveToFirestore(), 5000);
            });
    }

    const debouncedSave = Utils.debounce(() => {
        State.hasPendingChanges = true;
        saveToFirestore();
    }, PERFORMANCE.SAVE_INTERVAL);

    function forceSync() {
        if (!State.currentUser) {
            showNotification('Спочатку увійдіть в систему', 'error');
            return;
        }
        
        showNotification(t('notification.sync_in_progress'), 'info');
        State.hasPendingChanges = false;
        
        if (State.structureListener) {
            State.structureListener();
            State.structureListener = null;
        }
        
        loadFromFirestore();
    }

    function createBackup() {
        if (!State.currentUser || State.functions.length === 0) return;
        
        // Зберігаємо в ПЛОСКОМУ форматі (не вкладеному!)
        const backupData = {
            functions: State.functions,
            connections: State.connections,
            language: State.currentLanguage,
            timestamp: new Date().toISOString(),
            version: State.dataVersion,
            functionsCount: State.functions.length
        };
        
        const backupId = Utils.formatDate() + '_' + Date.now();
        
        // Зберігаємо в Firebase
        db.collection('users').doc(State.currentUser.uid)
            .collection('backups').doc(backupId).set(backupData)
            .then(() => {
                console.log('[BACKUP] Створено:', backupId, '- функцій:', State.functions.length);
                // Очищаємо старі бекапи (залишаємо останні 30)
                cleanupOldBackups();
            })
            .catch(error => console.error('[ERR] Помилка бекапу:', error));
        
        // Також зберігаємо локально
        try {
            localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify(backupData));
        } catch (err) {
            console.warn('[WARN] Не вдалося зберегти локальний backup');
        }
    }
    
    function cleanupOldBackups() {
        if (!State.currentUser) return;
        
        const MAX_BACKUPS = 30;
        
        db.collection('users').doc(State.currentUser.uid)
            .collection('backups')
            .orderBy('timestamp', 'desc')
            .get()
            .then(snapshot => {
                if (snapshot.size > MAX_BACKUPS) {
                    const toDelete = snapshot.docs.slice(MAX_BACKUPS);
                    const batch = db.batch();
                    toDelete.forEach(doc => batch.delete(doc.ref));
                    batch.commit()
                        .then(() => console.log('[CLEANUP] Видалено', toDelete.length, 'старих бекапів'))
                        .catch(err => console.error('[ERR] Помилка очищення бекапів:', err));
                }
            })
            .catch(err => console.error('[ERR] Помилка отримання бекапів:', err));
    }

    // === TOOL MANAGEMENT ===
    function setTool(tool) {
        State.currentTool = tool;
        State.connectingFrom = null;
        
        const selectBtn = Utils.getElement('selectTool');
        const handBtn = Utils.getElement('handTool');
        const connectBtn = Utils.getElement('connectTool');
        const container = Utils.getElement('canvasContainer');
        
        [selectBtn, handBtn, connectBtn].forEach(btn => {
            if (btn) {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
            }
        });
        
        const activeBtn = tool === 'select' ? selectBtn : tool === 'hand' ? handBtn : connectBtn;
        if (activeBtn) {
            activeBtn.classList.add('active');
            activeBtn.setAttribute('aria-pressed', 'true');
        }
        
        Utils.queryAll('.function-card').forEach(card => {
            card.classList.remove('connecting', 'selected', 'connect-target');
        });
        
        if (container) {
            container.classList.remove('panning', 'connecting');
            if (tool === 'hand') {
                container.style.cursor = 'grab';
            } else if (tool === 'connect') {
                container.style.cursor = 'crosshair';
                container.classList.add('connecting');
            } else {
                container.style.cursor = 'default';
            }
        }
    }

    // === FUNCTION MANAGEMENT ===
    function addFunction(parentIndex = null) {
        State.parentFunction = parentIndex;
        openModal();
    }

    function addSubFunction(parentIndex) {
        State.parentFunction = parentIndex;
        openModal();
    }

    function openModal(index = -1) {
        const modal = Utils.getElement('modal');
        const modalTitle = Utils.getElement('modalTitle');
        
        State.editingIndex = index;
        State.currentEmployees = [];
        State.currentStats = [];
        State.selectedColor = 'default';
        
        // Reset form
        const form = Utils.getElement('functionForm');
        if (form) form.reset();
        
        if (index >= 0 && State.functions[index]) {
            const func = State.functions[index];
            if (modalTitle) modalTitle.textContent = t('modal.edit_function');
            
            const nameInput = Utils.getElement('functionName');
            const responsibleInput = Utils.getElement('responsible');
            const linkInput = Utils.getElement('descriptionLink');
            const kpiInput = Utils.getElement('kpi');
            
            if (nameInput) nameInput.value = func.name || '';
            if (responsibleInput) responsibleInput.value = func.responsible || '';
            if (linkInput) linkInput.value = func.link || '';
            if (kpiInput) kpiInput.value = func.kpi || '';
            
            State.currentStats = (func.statisticsArray || []).map(s => ({...s}));
            State.currentEmployees = [...(func.employees || [])];
            State.selectedColor = func.color || 'default';
        } else {
            if (modalTitle) {
                modalTitle.textContent = State.parentFunction !== null 
                    ? t('modal.add_subfunction') 
                    : t('modal.add_function');
            }
        }
        
        updateEmployeesInput();
        updateColorPicker();
        renderStatsForm();
        
        if (modal) {
            modal.classList.add('show');
            // Focus first input
            setTimeout(() => {
                const firstInput = Utils.getElement('functionName');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    }

    function closeModal() {
        const modal = Utils.getElement('modal');
        if (modal) modal.classList.remove('show');
        
        State.editingIndex = -1;
        State.currentEmployees = [];
        State.currentStats = [];
        State.parentFunction = null;
    }

    function saveFunction() {
        const nameInput = Utils.getElement('functionName');
        const responsibleInput = Utils.getElement('responsible');
        const linkInput = Utils.getElement('descriptionLink');
        const kpiInput = Utils.getElement('kpi');
        
        const name = (nameInput?.value || '').trim();
        const responsible = (responsibleInput?.value || '').trim();
        const link = (linkInput?.value || '').trim();
        const kpi = (kpiInput?.value || '').trim();
        
        // Validation
        if (!name || !responsible) {
            showNotification(t('modal.required_fields'), 'error');
            if (!name && nameInput) {
                nameInput.classList.add('error');
                nameInput.focus();
            }
            if (!responsible && responsibleInput) {
                responsibleInput.classList.add('error');
            }
            return;
        }
        
        // Validate URL if provided
        if (link && !Utils.isValidUrl(link)) {
            showNotification('Невірний формат URL', 'error');
            if (linkInput) {
                linkInput.classList.add('error');
                linkInput.focus();
            }
            return;
        }
        
        // Calculate position
        let x, y;
        if (State.editingIndex >= 0) {
            x = State.functions[State.editingIndex].x;
            y = State.functions[State.editingIndex].y;
        } else if (State.parentFunction !== null && State.functions[State.parentFunction]) {
            const parent = State.functions[State.parentFunction];
            x = parent.x + Math.random() * 100 - 50;
            y = parent.y + 250;
        } else {
            x = Math.random() * 300 + 100;
            y = Math.random() * 200 + 100;
        }
        
        const functionData = {
            id: State.editingIndex >= 0 ? State.functions[State.editingIndex].id : Utils.generateId(),
            name,
            responsible,
            link,
            kpi,
            statisticsArray: [...State.currentStats],
            employees: [...State.currentEmployees],
            color: State.selectedColor,
            x,
            y,
            created: State.editingIndex >= 0 
                ? State.functions[State.editingIndex].created 
                : new Date().toISOString(),
            modified: new Date().toISOString()
        };
        
        if (State.editingIndex >= 0) {
            State.functions[State.editingIndex] = functionData;
        } else {
            const newIndex = State.functions.length;
            State.functions.push(functionData);
            
            if (State.parentFunction !== null) {
                State.connections.push({ from: State.parentFunction, to: newIndex });
            }
        }
        
        closeModal();
        
        if (typeof window.renderFunctions === 'function') {
            window.renderFunctions();
        }
        
        debouncedSave();
    }

    function deleteFunction(index) {
        if (index < 0 || index >= State.functions.length) return;
        
        State.deletingIndex = index;
        const functionName = State.functions[index].name;
        const nameElement = Utils.getElement('deleteFunctionName');
        if (nameElement) nameElement.textContent = functionName;
        
        const confirmModal = Utils.getElement('confirmModal');
        if (confirmModal) confirmModal.classList.add('show');
    }

    function closeConfirmModal() {
        const confirmModal = Utils.getElement('confirmModal');
        if (confirmModal) confirmModal.classList.remove('show');
        State.deletingIndex = -1;
    }

    function confirmDelete() {
        if (State.deletingIndex < 0 || State.deletingIndex >= State.functions.length) {
            closeConfirmModal();
            return;
        }
        
        const deletingIndex = State.deletingIndex;
        
        // Reconnect children to parents
        const incomingConnections = State.connections.filter(conn => conn.to === deletingIndex);
        const outgoingConnections = State.connections.filter(conn => conn.from === deletingIndex);
        
        const newConnections = [];
        incomingConnections.forEach(incoming => {
            outgoingConnections.forEach(outgoing => {
                const exists = State.connections.find(conn => 
                    conn.from === incoming.from && conn.to === outgoing.to
                );
                if (!exists && incoming.from !== outgoing.to) {
                    newConnections.push({
                        from: incoming.from > deletingIndex ? incoming.from - 1 : incoming.from,
                        to: outgoing.to > deletingIndex ? outgoing.to - 1 : outgoing.to
                    });
                }
            });
        });
        
        // Remove connections to/from deleted node
        State.connections = State.connections
            .filter(conn => conn.from !== deletingIndex && conn.to !== deletingIndex)
            .map(conn => ({
                from: conn.from > deletingIndex ? conn.from - 1 : conn.from,
                to: conn.to > deletingIndex ? conn.to - 1 : conn.to
            }));
        
        // Add new connections
        State.connections.push(...newConnections);
        
        // Remove function
        State.functions.splice(deletingIndex, 1);
        
        if (typeof window.renderFunctions === 'function') {
            window.renderFunctions();
        }
        
        debouncedSave();
        closeConfirmModal();
    }

    // === STATISTICS MANAGEMENT ===
    function addStatField(name = '', value = '', color = 'blue') {
        State.currentStats.push({
            id: Utils.generateId(),
            name,
            value,
            color
        });
        renderStatsForm();
    }

    function removeStatField(id) {
        State.currentStats = State.currentStats.filter(stat => stat.id !== id);
        renderStatsForm();
    }

    function updateStatField(id, field, value) {
        const stat = State.currentStats.find(s => s.id === id);
        if (stat) stat[field] = value;
    }

    function getStatColorValue(colorName) {
        const colorMap = {
            blue: 'rgba(66, 153, 225, 0.8)',
            green: 'rgba(72, 187, 120, 0.8)',
            red: 'rgba(245, 101, 101, 0.8)',
            yellow: 'rgba(236, 201, 75, 0.8)',
            purple: 'rgba(159, 122, 234, 0.8)',
            orange: 'rgba(237, 137, 54, 0.8)',
            teal: 'rgba(79, 209, 199, 0.8)',
            pink: 'rgba(237, 100, 166, 0.8)',
            gray: 'rgba(113, 128, 150, 0.8)'
        };
        return colorMap[colorName] || colorMap.blue;
    }

    function renderStatsForm() {
        const container = Utils.getElement('statsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        State.currentStats.forEach((stat) => {
            const row = document.createElement('div');
            row.className = 'stat-input-row';
            row.draggable = true;
            row.dataset.statId = stat.id;
            row.setAttribute('role', 'listitem');
            
            row.innerHTML = `
                <div class="drag-handle" aria-hidden="true"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="5" r="2"/><circle cx="9" cy="12" r="2"/><circle cx="9" cy="19" r="2"/><circle cx="15" cy="5" r="2"/><circle cx="15" cy="12" r="2"/><circle cx="15" cy="19" r="2"/></svg></div>
                <div class="stat-color-dropdown">
                    <div class="stat-color-selector" 
                         data-stat-id="${Utils.escapeHtml(stat.id)}" 
                         style="background: ${getStatColorValue(stat.color)}"
                         tabindex="0"
                         role="button"
                         aria-label="Вибрати колір"></div>
                    <div class="stat-color-options" id="colorOptions${Utils.escapeHtml(stat.id)}">
                        ${STAT_COLORS.map(color => `
                            <div class="stat-color-option ${color}" 
                                 data-stat-id="${Utils.escapeHtml(stat.id)}" 
                                 data-color="${color}"
                                 tabindex="0"
                                 role="option"></div>
                        `).join('')}
                    </div>
                </div>
                <input type="text" 
                       class="stat-name-input" 
                       value="${Utils.escapeHtml(stat.name)}" 
                       placeholder="Назва"
                       data-stat-id="${Utils.escapeHtml(stat.id)}" 
                       data-field="name"
                       maxlength="50">
                <input type="text" 
                       class="stat-value-input" 
                       value="${Utils.escapeHtml(stat.value)}" 
                       placeholder="Значення"
                       data-stat-id="${Utils.escapeHtml(stat.id)}" 
                       data-field="value"
                       maxlength="20">
                <button type="button" 
                        class="remove-stat-btn" 
                        data-stat-id="${Utils.escapeHtml(stat.id)}"
                        aria-label="Видалити метрику"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            `;
            
            setupStatDragAndDrop(row, stat);
            container.appendChild(row);
        });
    }

    function setupStatDragAndDrop(row, stat) {
        row.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', stat.id);
            row.classList.add('dragging');
        });
        
        row.addEventListener('dragend', () => {
            row.classList.remove('dragging');
        });
        
        row.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
        
        row.addEventListener('drop', (e) => {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetIndex = State.currentStats.findIndex(s => s.id === stat.id);
            const draggedIndex = State.currentStats.findIndex(s => s.id === draggedId);
            
            if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
                const draggedStat = State.currentStats.splice(draggedIndex, 1)[0];
                State.currentStats.splice(targetIndex, 0, draggedStat);
                renderStatsForm();
            }
        });
    }

    function toggleStatColorDropdown(statId) {
        Utils.queryAll('.stat-color-options').forEach(dropdown => {
            if (dropdown.id !== `colorOptions${statId}`) {
                dropdown.classList.remove('show');
            }
        });
        
        const dropdown = Utils.getElement(`colorOptions${statId}`);
        if (dropdown) dropdown.classList.toggle('show');
    }

    function setStatColor(statId, color) {
        updateStatField(statId, 'color', color);
        const selector = Utils.query(`[data-stat-id="${statId}"].stat-color-selector`);
        if (selector) {
            selector.style.background = getStatColorValue(color);
        }
        const dropdown = Utils.getElement(`colorOptions${statId}`);
        if (dropdown) dropdown.classList.remove('show');
    }

    // === EMPLOYEE MANAGEMENT ===
    function addEmployee(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const input = event.target;
            const name = (input.value || '').trim();
            
            if (name && !State.currentEmployees.includes(name)) {
                State.currentEmployees.push(name);
                input.value = '';
                updateEmployeesInput();
            }
        }
    }

    function removeEmployee(index) {
        State.currentEmployees.splice(index, 1);
        updateEmployeesInput();
    }

    function updateEmployeesInput() {
        const container = Utils.getElement('employeesInput');
        if (!container) return;
        
        container.innerHTML = '';
        
        State.currentEmployees.forEach((employee, index) => {
            const tag = document.createElement('div');
            tag.className = 'employee-input-tag';
            tag.innerHTML = `
                ${Utils.escapeHtml(employee)}
                <button type="button" class="remove-employee" data-index="${index}" aria-label="Видалити ${Utils.escapeHtml(employee)}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            `;
            container.appendChild(tag);
        });
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'employee-input-field';
        input.placeholder = t('modal.employees_placeholder');
        input.maxLength = 50;
        container.appendChild(input);
    }

    // === COLOR MANAGEMENT ===
    function updateColorPicker() {
        Utils.queryAll('.color-option').forEach(option => {
            const isSelected = option.dataset.color === State.selectedColor;
            option.classList.toggle('selected', isSelected);
            option.setAttribute('aria-checked', isSelected ? 'true' : 'false');
            option.tabIndex = isSelected ? 0 : -1;
        });
    }

    // === DROPDOWN MENUS ===
    function toggleMenu(menuId, btnId) {
        const menu = Utils.getElement(menuId);
        const btn = Utils.getElement(btnId);
        
        if (!menu) return;
        
        // Close other menus
        Utils.queryAll('.ecosystem-menu, .export-menu').forEach(m => {
            if (m.id !== menuId) m.classList.remove('show');
        });
        
        const isOpen = menu.classList.toggle('show');
        
        if (btn) {
            btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }
    }

    // === ZOOM LEVEL DISPLAY ===
    function updateZoomLevel() {
        const zoomEl = Utils.getElement('zoomLevel');
        if (zoomEl) {
            zoomEl.textContent = Math.round(State.scale * 100) + '%';
        }
    }

    // === EVENT LISTENERS SETUP ===
    function setupEventListeners() {
        // Login form
        const loginForm = Utils.getElement('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = Utils.getElement('emailInput')?.value?.trim() || '';
                const password = Utils.getElement('passwordInput')?.value || '';
                
                console.log('[LOGIN] Спроба входу:', email);
                showLoginLoading(true);
                
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log('[OK] Успішний вхід:', userCredential.user.uid);
                    })
                    .catch(error => {
                        showLoginLoading(false);
                        console.error('Login error:', error.code, error.message);
                        
                        const errorMessages = {
                            'auth/user-not-found': 'login.error.user_not_found',
                            'auth/wrong-password': 'login.error.wrong_password',
                            'auth/invalid-email': 'login.error.invalid_email',
                            'auth/too-many-requests': 'login.error.too_many_requests',
                            'auth/invalid-credential': 'login.error.wrong_password',
                            'auth/invalid-login-credentials': 'login.error.wrong_password'
                        };
                        
                        const message = t(errorMessages[error.code] || 'login.error.default');
                        showLoginError(message);
                    });
            });
        }

        // Auth state observer
        auth.onAuthStateChanged(user => {
            if (user) {
                State.currentUser = user;
                const emailEl = Utils.getElement('userEmail');
                if (emailEl) emailEl.textContent = user.email;
                
                showLoginLoading(false);
                cleanupListeners();
                hideLogin();
                
                console.log('[OK] Користувач авторизований:', user.uid);
                
                loadFromFirestore();
                startConnectionMonitoring();
                
                // Daily backup
                const lastBackup = localStorage.getItem('lastBackup_' + user.uid);
                const today = new Date().toDateString();
                if (lastBackup !== today) {
                    setTimeout(() => {
                        createBackup();
                        localStorage.setItem('lastBackup_' + user.uid, today);
                    }, 5000);
                }
            } else {
                State.currentUser = null;
                cleanupListeners();
                showLogin();
                State.functions = [];
                State.connections = [];
                
                if (typeof window.renderFunctions === 'function') {
                    window.renderFunctions();
                }
            }
        });

        // Language selector
        const languageBtn = Utils.getElement('languageBtn');
        if (languageBtn) {
            languageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const options = Utils.getElement('languageOptions');
                if (options) options.classList.toggle('show');
            });
        }

        // Language options (delegation)
        const languageOptions = Utils.getElement('languageOptions');
        if (languageOptions) {
            languageOptions.addEventListener('click', (e) => {
                const option = e.target.closest('.language-option');
                if (option?.dataset.lang) {
                    changeLanguage(option.dataset.lang);
                }
            });
        }

        // Toolbar buttons
        Utils.getElement('addFunctionBtn')?.addEventListener('click', () => addFunction());
        Utils.getElement('addFirstBtn')?.addEventListener('click', () => addFunction());
        Utils.getElement('mobileFab')?.addEventListener('click', () => addFunction());
        Utils.getElement('selectTool')?.addEventListener('click', () => setTool('select'));
        Utils.getElement('handTool')?.addEventListener('click', () => setTool('hand'));
        Utils.getElement('connectTool')?.addEventListener('click', () => setTool('connect'));
        Utils.getElement('logoutBtn')?.addEventListener('click', logout);
        
        // AI Assistants dropdown toggle
        Utils.getElement('aiAssistantsBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu('aiMenu', 'aiAssistantsBtn');
            document.querySelector('.ai-dropdown')?.classList.toggle('open');
        });
        
        Utils.getElement('copyBtn')?.addEventListener('click', () => {
            if (typeof window.copyStructure === 'function') window.copyStructure();
        });
        
        Utils.getElement('pasteBtn')?.addEventListener('click', () => {
            if (typeof window.pasteStructure === 'function') window.pasteStructure();
        });
        
        Utils.getElement('showAllBtn')?.addEventListener('click', () => {
            if (typeof window.zoomToFit === 'function') window.zoomToFit();
        });

        // Dropdown menus (SINGLE definition)
        Utils.getElement('ecosystemBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu('ecosystemMenu', 'ecosystemBtn');
        });
        
        Utils.getElement('exportBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu('exportMenu', 'exportBtn');
        });
        
        Utils.getElement('supportBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu('supportMenu', 'supportBtn');
        });

        // Export buttons
        Utils.getElement('exportJpegBtn')?.addEventListener('click', () => {
            Utils.getElement('exportMenu')?.classList.remove('show');
            if (typeof window.exportToJPEG === 'function') window.exportToJPEG();
        });
        
        Utils.getElement('exportPdfBtn')?.addEventListener('click', () => {
            Utils.getElement('exportMenu')?.classList.remove('show');
            if (typeof window.exportToPDF === 'function') window.exportToPDF();
        });
        
        Utils.getElement('exportExcelBtn')?.addEventListener('click', () => {
            Utils.getElement('exportMenu')?.classList.remove('show');
            if (typeof window.exportToExcel === 'function') window.exportToExcel();
        });

        // Backup restore button
        Utils.getElement('backupRestoreBtn')?.addEventListener('click', () => {
            Utils.getElement('supportMenu')?.classList.remove('show');
            if (typeof window.showBackupModal === 'function') window.showBackupModal();
        });

        // Backup modal cancel button
        Utils.getElement('backupCancelBtn')?.addEventListener('click', () => {
            if (typeof window.closeBackupModal === 'function') window.closeBackupModal();
        });

        // Zoom buttons
        Utils.getElement('zoomInBtn')?.addEventListener('click', () => {
            if (typeof window.zoomIn === 'function') window.zoomIn();
        });
        
        Utils.getElement('zoomOutBtn')?.addEventListener('click', () => {
            if (typeof window.zoomOut === 'function') window.zoomOut();
        });

        // Modal buttons
        Utils.getElement('cancelBtn')?.addEventListener('click', closeModal);
        Utils.getElement('saveBtn')?.addEventListener('click', saveFunction);
        Utils.getElement('addStatBtn')?.addEventListener('click', () => addStatField());

        // Color picker (delegation)
        const colorPicker = Utils.getElement('colorPicker');
        if (colorPicker) {
            colorPicker.addEventListener('click', (e) => {
                const option = e.target.closest('.color-option');
                if (option?.dataset.color) {
                    State.selectedColor = option.dataset.color;
                    updateColorPicker();
                }
            });
        }

        // Stats container (delegation)
        const statsContainer = Utils.getElement('statsContainer');
        if (statsContainer) {
            statsContainer.addEventListener('click', (e) => {
                const colorSelector = e.target.closest('.stat-color-selector');
                if (colorSelector?.dataset.statId) {
                    toggleStatColorDropdown(colorSelector.dataset.statId);
                    return;
                }
                
                const colorOption = e.target.closest('.stat-color-option');
                if (colorOption?.dataset.statId && colorOption?.dataset.color) {
                    setStatColor(colorOption.dataset.statId, colorOption.dataset.color);
                    return;
                }
                
                const removeBtn = e.target.closest('.remove-stat-btn');
                if (removeBtn?.dataset.statId) {
                    removeStatField(removeBtn.dataset.statId);
                }
            });
            
            statsContainer.addEventListener('input', (e) => {
                const input = e.target;
                if ((input.classList.contains('stat-name-input') || input.classList.contains('stat-value-input')) 
                    && input.dataset.statId && input.dataset.field) {
                    updateStatField(input.dataset.statId, input.dataset.field, input.value);
                }
            });
        }

        // Employees input (delegation)
        const employeesInput = Utils.getElement('employeesInput');
        if (employeesInput) {
            employeesInput.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-employee');
                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index);
                    if (!isNaN(index)) removeEmployee(index);
                }
                
                // Focus input when clicking container
                const input = employeesInput.querySelector('.employee-input-field');
                if (input && e.target === employeesInput) input.focus();
            });
            
            employeesInput.addEventListener('keypress', (e) => {
                if (e.target.classList.contains('employee-input-field')) {
                    addEmployee(e);
                }
            });
        }

        // Confirm modal buttons
        Utils.getElement('confirmCancelBtn')?.addEventListener('click', closeConfirmModal);
        Utils.getElement('confirmDeleteBtn')?.addEventListener('click', confirmDelete);

        // Modal close on backdrop click
        Utils.getElement('modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });
        
        Utils.getElement('confirmModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') closeConfirmModal();
        });

        Utils.getElement('backupModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'backupModal' && typeof window.closeBackupModal === 'function') window.closeBackupModal();
        });

        // Close dropdowns on outside click (SINGLE handler)
        document.addEventListener('click', (e) => {
            // Language dropdown
            if (!e.target.closest('.language-dropdown')) {
                Utils.getElement('languageOptions')?.classList.remove('show');
            }
            
            // Stat color dropdowns
            if (!e.target.closest('.stat-color-dropdown')) {
                Utils.queryAll('.stat-color-options').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
            
            // Export menu
            if (!e.target.closest('.export-dropdown')) {
                Utils.getElement('exportMenu')?.classList.remove('show');
            }
            
            // Ecosystem menu
            if (!e.target.closest('.ecosystem-dropdown')) {
                Utils.getElement('ecosystemMenu')?.classList.remove('show');
            }
            
            // Support menu
            if (!e.target.closest('.support-dropdown')) {
                Utils.getElement('supportMenu')?.classList.remove('show');
            }
            
            // AI menu
            if (!e.target.closest('.ai-dropdown')) {
                Utils.getElement('aiMenu')?.classList.remove('show');
                document.querySelector('.ai-dropdown')?.classList.remove('open');
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeConfirmModal();
                Utils.queryAll('.ecosystem-menu, .export-menu, .support-menu, .ai-menu, .language-options').forEach(m => {
                    m.classList.remove('show');
                });
                document.querySelector('.ai-dropdown')?.classList.remove('open');
            }
        });

        // Form input error clearing
        Utils.queryAll('.form-input').forEach(input => {
            input.addEventListener('input', () => {
                input.classList.remove('error');
            });
        });

        // Save before unload
        window.addEventListener('beforeunload', (e) => {
            cleanupListeners();
            
            if (State.currentUser && State.functions.length > 0) {
                // Зберігаємо в localStorage як резервну копію
                try {
                    const backupData = {
                        functions: State.functions,
                        connections: State.connections,
                        language: State.currentLanguage,
                        timestamp: Date.now(),
                        userId: State.currentUser.uid
                    };
                    localStorage.setItem('talko_local_backup_' + State.currentUser.uid, JSON.stringify(backupData));
                    console.log('[BACKUP] Локальний backup збережено');
                } catch (err) {
                    console.error('[ERR] Помилка локального backup:', err);
                }
                
                // Якщо є незбережені зміни - попередити
                if (State.hasPendingChanges) {
                    e.preventDefault();
                    e.returnValue = 'У вас є незбережені зміни. Ви впевнені що хочете вийти?';
                    return e.returnValue;
                }
            }
        });

        // Resize handler (debounced)
        window.addEventListener('resize', Utils.debounce(() => {
            if (typeof window.renderConnections === 'function') {
                window.renderConnections();
            }
        }, 250));
    }

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
        console.log('[START] TALKO System v3.3 Block 2 initializing...');
        loadLanguage();
        setupEventListeners();
        console.log('[OK] TALKO System v3.3 Block 2 ready!');
    });

    // === EXPORT TO GLOBAL SCOPE ===
    // State getters (read-only access)
    Object.defineProperty(window, 'functions', {
        get: () => State.functions,
        set: (val) => { State.functions = val; }
    });
    
    Object.defineProperty(window, 'connections', {
        get: () => State.connections,
        set: (val) => { State.connections = val; }
    });
    
    Object.defineProperty(window, 'currentUser', {
        get: () => State.currentUser
    });
    
    Object.defineProperty(window, 'currentTool', {
        get: () => State.currentTool,
        set: (val) => { State.currentTool = val; }
    });
    
    Object.defineProperty(window, 'scale', {
        get: () => State.scale,
        set: (val) => { 
            State.scale = val;
            updateZoomLevel();
        }
    });
    
    Object.defineProperty(window, 'panX', {
        get: () => State.panX,
        set: (val) => { State.panX = val; }
    });
    
    Object.defineProperty(window, 'panY', {
        get: () => State.panY,
        set: (val) => { State.panY = val; }
    });
    
    Object.defineProperty(window, 'isPanning', {
        get: () => State.isPanning,
        set: (val) => { State.isPanning = val; }
    });
    
    Object.defineProperty(window, 'lastPanPoint', {
        get: () => State.lastPanPoint,
        set: (val) => { State.lastPanPoint = val; }
    });
    
    Object.defineProperty(window, 'connectingFrom', {
        get: () => State.connectingFrom,
        set: (val) => { State.connectingFrom = val; }
    });

    // Functions export
    window.addFunction = addFunction;
    window.addSubFunction = addSubFunction;
    window.deleteFunction = deleteFunction;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.saveFunction = saveFunction;
    window.closeConfirmModal = closeConfirmModal;
    window.confirmDelete = confirmDelete;
    window.setTool = setTool;
    window.forceSync = forceSync;
    window.t = t;
    window.showNotification = showNotification;
    window.debouncedSave = debouncedSave;
    window.Utils = Utils;
    window.State = State; // For debugging
    window.STAT_COLORS = STAT_COLORS;
    window.getStatColorValue = getStatColorValue;
    window.updateZoomLevel = updateZoomLevel;
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;

    // Debug functions
    window.debugUserData = function() {
        if (!State.currentUser) {
            console.log('[ERR] Користувач не авторизований');
            return;
        }
        
        console.log('🔍 ДІАГНОСТИКА:', {
            userId: State.currentUser.uid,
            functions: State.functions.length,
            connections: State.connections.length,
            version: State.dataVersion,
            lastSave: new Date(State.lastLocalSaveTime).toISOString(),
            isOnline: State.isOnline,
            isSaving: State.isSaving
        });
    };

})();
</script>

<script>
// ============================================================================
// TALKO SYSTEM v3.3 - BLOCK 3: RENDERING + EXPORT (FIXED)
// ============================================================================

(function() {
    'use strict';

    // Wait for Block 2 to be ready
    const waitForDependencies = () => {
        return new Promise((resolve) => {
            const check = () => {
                if (typeof window.Utils !== 'undefined' && 
                    typeof window.t === 'function' && 
                    typeof window.showNotification === 'function') {
                    resolve();
                } else {
                    setTimeout(check, 50);
                }
            };
            check();
        });
    };

    // === COPY/PASTE FUNCTIONALITY ===
    function copyStructure() {
        console.log('[COPY] copyStructure викликано');
        
        if (!window.functions || window.functions.length === 0) {
            const msg = window.t ? window.t('notification.no_functions_to_copy') : 'Немає функцій для копіювання';
            window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
            return;
        }

        const structureData = {
            talkoSystem: {
                functions: window.functions.map(func => ({
                    name: func.name,
                    responsible: func.responsible,
                    link: func.link || '',
                    kpi: func.kpi || '',
                    statisticsArray: func.statisticsArray || [],
                    employees: func.employees || [],
                    color: func.color || 'default',
                })),
                connections: [...window.connections],
                version: '3.3',
                exported: new Date().toISOString(),
                exportedBy: window.currentUser ? window.currentUser.email : 'unknown'
            }
        };

        const jsonString = JSON.stringify(structureData, null, 2);
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(jsonString)
                .then(() => {
                    console.log('[OK] Структура скопійована');
                    const msg = window.t ? window.t('notification.structure_copied') : 'Структуру скопійовано';
                    window.showNotification ? window.showNotification(msg, 'success') : alert(msg);
                })
                .catch(err => {
                    console.error('[ERR] Помилка копіювання:', err);
                    fallbackCopyToClipboard(jsonString);
                });
        } else {
            fallbackCopyToClipboard(jsonString);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.cssText = 'position:fixed;left:-9999px;top:-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            console.log('[OK] Скопійовано через fallback');
            const msg = window.t ? window.t('notification.structure_copied') : 'Структуру скопійовано';
            window.showNotification ? window.showNotification(msg, 'success') : alert(msg);
        } catch (err) {
            console.error('[ERR] Помилка fallback копіювання:', err);
            const msg = window.t ? window.t('notification.copy_error') : 'Помилка копіювання';
            window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
        }
        
        document.body.removeChild(textArea);
    }

    function pasteStructure() {
        console.log('[COPY] pasteStructure викликано');
        
        if (!navigator.clipboard || !navigator.clipboard.readText) {
            const msg = window.t ? window.t('notification.paste_not_supported') : 'Вставка не підтримується';
            window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
            return;
        }

        navigator.clipboard.readText()
            .then(text => {
                if (!text.trim()) {
                    const msg = window.t ? window.t('notification.clipboard_empty') : 'Буфер порожній';
                    window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                    return;
                }

                try {
                    const data = JSON.parse(text);
                    
                    if (!data.talkoSystem || !data.talkoSystem.functions) {
                        const msg = window.t ? window.t('notification.invalid_format') : 'Невірний формат';
                        window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                        return;
                    }

                    const importedFunctions = data.talkoSystem.functions;
                    const importedConnections = data.talkoSystem.connections || [];

                    if (importedFunctions.length === 0) {
                        const msg = window.t ? window.t('notification.no_functions') : 'Немає функцій';
                        window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                        return;
                    }

                    console.log('[OK] Знайдено функцій:', importedFunctions.length);
                    showPasteDialog(importedFunctions, importedConnections, data.talkoSystem.exportedBy);

                } catch (error) {
                    console.error('[ERR] Помилка парсингу:', error);
                    const msg = window.t ? window.t('notification.parse_error') : 'Помилка читання';
                    window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                }
            })
            .catch(err => {
                console.error('[ERR] Помилка буфера:', err);
                const msg = window.t ? window.t('notification.clipboard_error') : 'Помилка доступу';
                window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
            });
    }

    function showPasteDialog(importedFunctions, importedConnections, exportedBy) {
        const t = window.t || ((k) => k);
        
        // Remove existing dialog
        const existing = document.querySelector('.paste-dialog-modal');
        if (existing) existing.remove();
        
        const modal = document.createElement('div');
        modal.className = 'modal show paste-dialog-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>${t('modal.paste_structure')}</h2>
                </div>
                <div class="modal-body">
                    <p><strong>${t('modal.found')}:</strong> ${importedFunctions.length} ${t('modal.functions')}</p>
                    ${exportedBy ? `<p><strong>${t('modal.exported_by')}:</strong> ${window.Utils?.escapeHtml(exportedBy) || exportedBy}</p>` : ''}
                    <p><strong>${t('modal.current_functions')}:</strong> ${window.functions?.length || 0}</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                            <input type="radio" name="pasteMode" value="add" checked style="margin-right: 8px;">
                            ${t('modal.add_to_existing')}
                        </label>
                        <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                            <input type="radio" name="pasteMode" value="replace" style="margin-right: 8px;">
                            ${t('modal.replace_all')}
                        </label>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-top: 16px;">
                        <small style="color: var(--gray-600);">
                            ${t('modal.auto_arrange')}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="pasteCancelBtn">${t('modal.cancel')}</button>
                    <button class="btn btn-primary" id="pasteConfirmBtn">${t('modal.paste')}</button>
                </div>
            </div>
        `;
        
        // Store data for execution
        modal._pasteData = { functions: importedFunctions, connections: importedConnections };
        
        // Event handlers
        modal.querySelector('#pasteCancelBtn').addEventListener('click', () => modal.remove());
        modal.querySelector('#pasteConfirmBtn').addEventListener('click', () => executePaste(modal));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        document.body.appendChild(modal);
    }

    function executePaste(modal) {
        const pasteMode = modal.querySelector('input[name="pasteMode"]:checked')?.value || 'add';
        const { functions: importedFunctions, connections: importedConnections } = modal._pasteData;
        
        const startIndex = pasteMode === 'replace' ? 0 : window.functions.length;
        
        if (pasteMode === 'replace') {
            window.functions = [];
            window.connections = [];
        }
        
        const Utils = window.Utils || { generateId: () => Date.now() + '_' + Math.random().toString(36).substr(2, 9) };
        
        importedFunctions.forEach((func, index) => {
            const newFunction = {
                ...func,
                id: Utils.generateId(),
                x: 100 + (index % 3) * 320,
                y: 100 + Math.floor(index / 3) * 300,
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            window.functions.push(newFunction);
        });
        
        importedConnections.forEach(conn => {
            const newConnection = {
                from: conn.from + startIndex,
                to: conn.to + startIndex
            };
            
            if (newConnection.from < window.functions.length && newConnection.to < window.functions.length) {
                window.connections.push(newConnection);
            }
        });
        
        modal.remove();
        renderFunctions();
        
        if (typeof window.debouncedSave === 'function') {
            window.debouncedSave();
        }
        
        const msg = (window.t ? window.t('notification.functions_pasted') : 'Вставлено функцій:') + ' ' + importedFunctions.length;
        window.showNotification ? window.showNotification(msg, 'success') : alert(msg);
    }

    // === EXPORT FUNCTIONS ===
    async function exportToJPEG() {
        console.log('[IMG] exportToJPEG викликано');
        
        try {
            if (!window.functions || window.functions.length === 0) {
                const msg = 'Немає функцій для експорту';
                window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                return;
            }
            
            if (typeof html2canvas === 'undefined') {
                console.error('[ERR] html2canvas не знайдено');
                window.showNotification ? window.showNotification('Бібліотека html2canvas не завантажена', 'error') : alert('html2canvas not loaded');
                return;
            }

            const t = window.t || ((k) => k);
            window.showNotification ? window.showNotification(t('export.preparing'), 'info') : null;

            const canvas = document.getElementById('canvas');
            if (!canvas) {
                console.error('[ERR] Canvas не знайдено');
                return;
            }
            
            // Temporarily remove shadows for cleaner export
            const cards = document.querySelectorAll('.function-card');
            const originalStyles = [];
            
            cards.forEach((card, index) => {
                originalStyles[index] = {
                    boxShadow: card.style.boxShadow,
                    filter: card.style.filter
                };
                card.style.boxShadow = 'none';
                card.style.filter = 'none';
            });
            
            const svg = document.getElementById('connections');
            const originalSvgFilter = svg ? svg.style.filter : '';
            if (svg) svg.style.filter = 'none';
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log('📸 Створюємо screenshot...');
            
            const htmlCanvas = await html2canvas(canvas, {
                scale: 4, // High quality
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: false,
                removeContainer: true,
                ignoreElements: (element) => {
                    return element.classList.contains('empty-state') || 
                           element.classList.contains('plus-btn');
                }
            });
            
            // Restore styles
            cards.forEach((card, index) => {
                if (originalStyles[index]) {
                    card.style.boxShadow = originalStyles[index].boxShadow || '';
                    card.style.filter = originalStyles[index].filter || '';
                }
            });
            if (svg) svg.style.filter = originalSvgFilter;
            
            // Add links section if functions have links
            const functionsWithLinks = window.functions.filter(f => f && f.link);
            
            if (functionsWithLinks.length > 0) {
                const newCanvas = document.createElement('canvas');
                const ctx = newCanvas.getContext('2d');
                
                const linkListHeight = (functionsWithLinks.length * 60) + 150;
                newCanvas.width = htmlCanvas.width;
                newCanvas.height = htmlCanvas.height + linkListHeight;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
                ctx.drawImage(htmlCanvas, 0, 0);
                
                // Links section
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, htmlCanvas.height, newCanvas.width, linkListHeight);
                
                ctx.font = 'bold 48px Arial, sans-serif';
                ctx.fillStyle = '#1a1a1a';
                ctx.fillText(t('export.links_section'), 60, htmlCanvas.height + 80);
                
                ctx.font = '36px Arial, sans-serif';
                functionsWithLinks.forEach((func, index) => {
                    const y = htmlCanvas.height + 160 + (index * 60);
                    ctx.fillStyle = '#333333';
                    ctx.fillText(`• ${func.name}:`, 60, y);
                    ctx.fillStyle = '#0066cc';
                    ctx.fillText(func.link, 500, y);
                });
                
                const link = document.createElement('a');
                link.download = `TALKO_Structure_${new Date().toISOString().split('T')[0]}.jpeg`;
                link.href = newCanvas.toDataURL('image/jpeg', 0.95);
                link.click();
            } else {
                const link = document.createElement('a');
                link.download = `TALKO_Structure_${new Date().toISOString().split('T')[0]}.jpeg`;
                link.href = htmlCanvas.toDataURL('image/jpeg', 0.95);
                link.click();
            }
            
            console.log('[OK] JPEG експортовано');
            window.showNotification ? window.showNotification(t('export.success_jpeg'), 'success') : alert('JPEG saved!');
            
        } catch (error) {
            console.error('[ERR] Помилка JPEG:', error);
            const msg = window.t ? window.t('export.error') : 'Export error';
            window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
            
            // Restore styles on error
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.boxShadow = '';
                card.style.filter = '';
            });
            const svg = document.getElementById('connections');
            if (svg) svg.style.filter = '';
        }
    }

    async function exportToPDF() {
        console.log('[PDF] exportToPDF викликано');
        
        try {
            if (!window.functions || window.functions.length === 0) {
                const msg = 'Немає функцій для експорту';
                window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                return;
            }
            
            if (typeof html2canvas === 'undefined') {
                window.showNotification ? window.showNotification('html2canvas not loaded', 'error') : alert('html2canvas not loaded');
                return;
            }
            
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                window.showNotification ? window.showNotification('jsPDF not loaded', 'error') : alert('jsPDF not loaded');
                return;
            }

            const t = window.t || ((k) => k);
            window.showNotification ? window.showNotification(t('export.preparing'), 'info') : null;

            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            // Remove shadows
            const cards = document.querySelectorAll('.function-card');
            const originalStyles = [];
            
            cards.forEach((card, index) => {
                originalStyles[index] = {
                    boxShadow: card.style.boxShadow,
                    filter: card.style.filter
                };
                card.style.boxShadow = 'none';
                card.style.filter = 'none';
            });
            
            const svg = document.getElementById('connections');
            const originalSvgFilter = svg ? svg.style.filter : '';
            if (svg) svg.style.filter = 'none';
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const htmlCanvas = await html2canvas(canvas, {
                scale: 4,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: false,
                removeContainer: true,
                ignoreElements: (element) => {
                    return element.classList.contains('empty-state') || 
                           element.classList.contains('plus-btn');
                }
            });
            
            // Restore styles
            cards.forEach((card, index) => {
                if (originalStyles[index]) {
                    card.style.boxShadow = originalStyles[index].boxShadow || '';
                    card.style.filter = originalStyles[index].filter || '';
                }
            });
            if (svg) svg.style.filter = originalSvgFilter;
            
            const imgData = htmlCanvas.toDataURL('image/png');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const imgWidth = htmlCanvas.width;
            const imgHeight = htmlCanvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = (pdfHeight - imgHeight * ratio) / 2;
            
            pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            
            // Add clickable links
            let activeLinksCount = 0;
            
            cards.forEach((cardElement, index) => {
                const func = window.functions[index];
                if (!func || !func.link) return;
                
                const cardRect = cardElement.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const cardX = cardRect.left - canvasRect.left + canvas.scrollLeft;
                const cardY = cardRect.top - canvasRect.top + canvas.scrollTop;
                const cardWidth = cardRect.width;
                const cardHeight = cardRect.height;
                
                const scale = 4;
                const linkX = ((cardX * scale / imgWidth) * (imgWidth * ratio)) + imgX;
                const linkY = ((cardY * scale / imgHeight) * (imgHeight * ratio)) + imgY;
                const linkW = ((cardWidth * scale) / imgWidth) * (imgWidth * ratio);
                const linkH = ((cardHeight * scale) / imgHeight) * (imgHeight * ratio);
                
                try {
                    pdf.link(linkX, linkY, linkW, linkH, { url: func.link });
                    activeLinksCount++;
                } catch (error) {
                    console.error('Link error:', error);
                }
            });
            
            pdf.save(`TALKO_Structure_${new Date().toISOString().split('T')[0]}.pdf`);
            
            console.log(`✅ PDF: ${activeLinksCount} links`);
            
            const msg = activeLinksCount > 0 
                ? `${t('export.success_pdf')} (${activeLinksCount} ${t('export.active_links')})`
                : t('export.success_pdf');
            window.showNotification ? window.showNotification(msg, 'success') : alert(msg);
            
        } catch (error) {
            console.error('[ERR] PDF error:', error);
            window.showNotification ? window.showNotification(window.t ? window.t('export.error') : 'Error', 'error') : alert('Error');
            
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.boxShadow = '';
                card.style.filter = '';
            });
            const svg = document.getElementById('connections');
            if (svg) svg.style.filter = '';
        }
    }

    // === EXPORT TO EXCEL ===
    function exportToExcel() {
        console.log('[EXCEL] exportToExcel викликано');
        
        try {
            if (!window.functions || window.functions.length === 0) {
                const msg = 'Немає функцій для експорту';
                window.showNotification ? window.showNotification(msg, 'error') : alert(msg);
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                window.showNotification ? window.showNotification('XLSX library not loaded', 'error') : alert('XLSX library not loaded');
                return;
            }
            
            const t = window.t || ((k) => k);
            
            // Sheet 1: Functions
            const functionsData = window.functions.map((func, index) => ({
                '№': index + 1,
                'Назва функції': func.name || '',
                'Відповідальний': func.responsible || '',
                'KPI': func.kpi || '',
                'Посилання': func.link || '',
                'Працівники': func.employees ? func.employees.join(', ') : '',
                'Колір': func.color || 'default',
                'Позиція X': func.x || 0,
                'Позиція Y': func.y || 0,
                'Створено': func.created || '',
                'Змінено': func.modified || ''
            }));
            
            // Sheet 2: Statistics
            const statsData = [];
            window.functions.forEach((func, funcIndex) => {
                if (func.statisticsArray && func.statisticsArray.length > 0) {
                    func.statisticsArray.forEach((stat, statIndex) => {
                        statsData.push({
                            '№': statsData.length + 1,
                            'Функція': func.name || '',
                            'Показник': stat.name || '',
                            'Значення': stat.value || '',
                            'Колір': stat.color || 'blue'
                        });
                    });
                }
            });
            
            // Sheet 3: Connections
            const connectionsData = (window.connections || []).map((conn, index) => {
                const fromFunc = window.functions[conn.from];
                const toFunc = window.functions[conn.to];
                return {
                    '№': index + 1,
                    'Від (індекс)': conn.from,
                    'Від (назва)': fromFunc ? fromFunc.name : '',
                    'До (індекс)': conn.to,
                    'До (назва)': toFunc ? toFunc.name : ''
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add Functions sheet
            const wsFunctions = XLSX.utils.json_to_sheet(functionsData);
            
            // Set column widths for Functions sheet
            wsFunctions['!cols'] = [
                { wch: 4 },   // №
                { wch: 30 },  // Назва
                { wch: 20 },  // Відповідальний
                { wch: 30 },  // KPI
                { wch: 40 },  // Посилання
                { wch: 30 },  // Працівники
                { wch: 10 },  // Колір
                { wch: 10 },  // X
                { wch: 10 },  // Y
                { wch: 20 },  // Створено
                { wch: 20 }   // Змінено
            ];
            XLSX.utils.book_append_sheet(wb, wsFunctions, 'Функції');
            
            // Add Statistics sheet (if any)
            if (statsData.length > 0) {
                const wsStats = XLSX.utils.json_to_sheet(statsData);
                wsStats['!cols'] = [
                    { wch: 4 },   // №
                    { wch: 30 },  // Функція
                    { wch: 20 },  // Показник
                    { wch: 15 },  // Значення
                    { wch: 10 }   // Колір
                ];
                XLSX.utils.book_append_sheet(wb, wsStats, 'Статистика');
            }
            
            // Add Connections sheet (if any)
            if (connectionsData.length > 0) {
                const wsConnections = XLSX.utils.json_to_sheet(connectionsData);
                wsConnections['!cols'] = [
                    { wch: 4 },   // №
                    { wch: 12 },  // Від (індекс)
                    { wch: 30 },  // Від (назва)
                    { wch: 12 },  // До (індекс)
                    { wch: 30 }   // До (назва)
                ];
                XLSX.utils.book_append_sheet(wb, wsConnections, 'Звязки');
            }
            
            // Generate filename
            const filename = `TALKO_Structure_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            console.log(`✅ Excel: ${window.functions.length} функцій, ${statsData.length} показників, ${connectionsData.length} зв'язків`);
            
            const msg = `Експортовано: ${window.functions.length} функцій`;
            window.showNotification ? window.showNotification(msg, 'success') : alert(msg);
            
        } catch (error) {
            console.error('[ERR] Excel error:', error);
            window.showNotification ? window.showNotification('Помилка експорту в Excel', 'error') : alert('Помилка експорту в Excel');
        }
    }

    // === BACKUP RESTORE FUNCTIONS ===
    function showBackupModal() {
        const modal = document.getElementById('backupModal');
        const backupList = document.getElementById('backupList');
        
        if (!modal || !backupList) {
            console.error('[BACKUP] Modal elements not found');
            return;
        }
        
        if (!window.currentUser) {
            window.showNotification ? window.showNotification('Потрібна авторизація', 'error') : alert('Потрібна авторизація');
            return;
        }
        
        modal.classList.add('show');
        backupList.innerHTML = '<div class="backup-loading">Завантаження списку backup...</div>';
        
        loadBackupList();
    }
    
    function closeBackupModal() {
        const modal = document.getElementById('backupModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }
    
    async function loadBackupList() {
        const backupList = document.getElementById('backupList');
        if (!backupList) return;
        
        try {
            const userId = window.currentUser.uid;
            const db = firebase.firestore();
            
            const snapshot = await db.collection('users')
                .doc(userId)
                .collection('backups')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get();
            
            if (snapshot.empty) {
                backupList.innerHTML = '<div class="backup-empty">Backup-и не знайдено</div>';
                return;
            }
            
            let html = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const backupId = doc.id;
                const timestamp = data.timestamp ? new Date(data.timestamp) : null;
                const version = data.version || '?';
                
                // Підрахунок функцій
                let functionsCount = 0;
                if (data.structure && data.structure.functions) {
                    functionsCount = data.structure.functions.length;
                } else if (data.functions) {
                    functionsCount = data.functions.length;
                }
                
                // Формат дати
                const dateStr = timestamp 
                    ? timestamp.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : backupId.split('_')[0];
                
                html += `
                    <div class="backup-item" data-backup-id="${backupId}">
                        <div class="backup-item-info">
                            <div class="backup-item-date">${dateStr}</div>
                            <div class="backup-item-meta">${functionsCount} функцій • версія ${version}</div>
                        </div>
                        <button class="backup-item-btn" onclick="window.restoreBackup('${backupId}')">Відновити</button>
                    </div>
                `;
            });
            
            backupList.innerHTML = html;
            
        } catch (error) {
            console.error('[BACKUP] Error loading backups:', error);
            backupList.innerHTML = '<div class="backup-error">Помилка завантаження списку backup</div>';
        }
    }
    
    async function restoreBackup(backupId) {
        if (!confirm('Відновити структуру з цього backup?\n\nПоточна структура буде замінена!')) {
            return;
        }
        
        try {
            const userId = window.currentUser.uid;
            const db = firebase.firestore();
            
            // Завантажуємо backup
            const backupDoc = await db.collection('users')
                .doc(userId)
                .collection('backups')
                .doc(backupId)
                .get();
            
            if (!backupDoc.exists) {
                throw new Error('Backup не знайдено');
            }
            
            const backupData = backupDoc.data();
            
            // Визначаємо де функції - шукаємо на різних рівнях вкладеності
            let functions = [];
            let connections = [];
            let language = 'uk';
            
            if (backupData.functions) {
                functions = backupData.functions;
                connections = backupData.connections || [];
                language = backupData.language || backupData.Language || 'uk';
            } else if (backupData.structure && backupData.structure.functions) {
                functions = backupData.structure.functions;
                connections = backupData.structure.connections || [];
                language = backupData.structure.language || backupData.structure.Language || 'uk';
            }
            
            const functionsCount = functions.length;
            
            if (functionsCount === 0) {
                throw new Error('Backup пустий (0 функцій)');
            }
            
            // Зберігаємо в НОРМАЛІЗОВАНОМУ форматі (без вкладеності)
            await db.collection('users')
                .doc(userId)
                .collection('main')
                .doc('structure')
                .set({
                    functions: functions,
                    connections: connections,
                    language: language,
                    version: (backupData.version || 0) + 1,
                    lastModified: new Date().toISOString(),
                    restoredFrom: backupId,
                    restoredAt: new Date().toISOString()
                });
            
            console.log(`[BACKUP] Відновлено ${functionsCount} функцій з backup ${backupId}`);
            
            closeBackupModal();
            
            window.showNotification 
                ? window.showNotification(`Відновлено ${functionsCount} функцій! Оновлюю сторінку...`, 'success') 
                : alert(`Відновлено ${functionsCount} функцій!`);
            
            // Перезавантажуємо сторінку
            setTimeout(() => location.reload(), 1500);
            
        } catch (error) {
            console.error('[BACKUP] Restore error:', error);
            window.showNotification 
                ? window.showNotification('Помилка відновлення: ' + error.message, 'error') 
                : alert('Помилка відновлення: ' + error.message);
        }
    }

    // === MAIN RENDERING ===
    function renderFunctions() {
        const canvas = document.getElementById('canvas');
        const emptyState = document.getElementById('emptyState');
        
        if (!canvas || !emptyState) {
            console.error('[ERR] Canvas або emptyState не знайдено');
            return;
        }
        
        // Remove existing cards
        canvas.querySelectorAll('.function-card').forEach(card => card.remove());
        
        if (!window.functions || window.functions.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        // Create document fragment for better performance
        const fragment = document.createDocumentFragment();
        
        window.functions.forEach((func, index) => {
            const card = createFunctionCard(func, index);
            fragment.appendChild(card);
        });
        
        canvas.appendChild(fragment);
        renderConnections();
    }

    function createFunctionCard(func, index) {
        const t = window.t || ((k) => k);
        const Utils = window.Utils || { escapeHtml: (s) => s };
        
        const card = document.createElement('div');
        card.className = 'function-card';
        card.style.left = (func.x || 100) + 'px';
        card.style.top = (func.y || 100) + 'px';
        card.dataset.index = index;
        card.dataset.funcId = func.id || '';
        card.setAttribute('role', 'article');
        card.setAttribute('aria-label', func.name);
        
        // Statistics HTML (max 4 visible)
        const statsHTML = func.statisticsArray && func.statisticsArray.length > 0 ? 
            `<div class="stats-grid">
                ${func.statisticsArray.slice(0, 4).map(stat => `
                    <div class="stat-item ${Utils.escapeHtml(stat.color || 'blue')}">
                        <div class="stat-value">${Utils.escapeHtml(stat.value || '')}</div>
                        <div class="stat-label">${Utils.escapeHtml(stat.name || '')}</div>
                    </div>
                `).join('')}
            </div>` : '';
        
        // Employees HTML (max 4 visible + counter)
        const employeesHTML = func.employees && func.employees.length > 0 ? 
            `<div class="employees-list">
                ${func.employees.slice(0, 4).map(emp => 
                    `<span class="employee-tag">${Utils.escapeHtml(emp)}</span>`
                ).join('')}
                ${func.employees.length > 4 ? 
                    `<span class="employee-tag">+${func.employees.length - 4}</span>` : ''}
            </div>` : '';
        
        card.innerHTML = `
            <div class="card-header ${Utils.escapeHtml(func.color || 'default')}">
                <div class="card-title">${Utils.escapeHtml(func.name || '')}</div>
                <div class="card-responsible">${Utils.escapeHtml(func.responsible || '')}</div>
                <div class="card-actions">
                    <button class="action-btn edit-btn" 
                            data-index="${index}" 
                            title="${t('card.edit_tooltip')}"
                            aria-label="${t('card.edit_tooltip')}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="action-btn delete delete-btn" 
                            data-index="${index}" 
                            title="${t('card.delete_tooltip')}"
                            aria-label="${t('card.delete_tooltip')}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
                <button class="plus-btn add-sub-btn" 
                        data-index="${index}" 
                        title="${t('card.add_subfunction')}"
                        aria-label="${t('card.add_subfunction')}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            </div>
            <div class="card-body">
                ${func.kpi ? `
                    <div class="card-field">
                        <div class="field-label">${t('field.kpi')}</div>
                        <div class="field-value">${Utils.escapeHtml(func.kpi)}</div>
                    </div>
                ` : ''}
                ${func.link ? `
                    <div class="card-field">
                        <div class="field-label">${t('field.description')}</div>
                        <a href="${Utils.escapeHtml(func.link)}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="field-link">${t('field.view_instruction')}</a>
                    </div>
                ` : ''}
                ${func.employees && func.employees.length > 0 ? `
                    <div class="card-field">
                        <div class="field-label">${t('field.employees')}</div>
                        ${employeesHTML}
                    </div>
                ` : ''}
                ${statsHTML}
            </div>
        `;
        
        // Add event listeners using delegation-friendly approach
        setupCardEventListeners(card, index);
        
        return card;
    }

    // Centralized drag state (to avoid memory leaks)
    const dragState = {
        isDragging: false,
        currentCard: null,
        startX: 0,
        startY: 0,
        initialX: 0,
        initialY: 0
    };

    function setupCardEventListeners(card, index) {
        // Click handlers via delegation
        card.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const addSubBtn = e.target.closest('.add-sub-btn');
            const link = e.target.closest('.field-link');
            
            if (editBtn) {
                e.stopPropagation();
                if (typeof window.openModal === 'function') {
                    window.openModal(parseInt(editBtn.dataset.index));
                }
                return;
            }
            
            if (deleteBtn) {
                e.stopPropagation();
                if (typeof window.deleteFunction === 'function') {
                    window.deleteFunction(parseInt(deleteBtn.dataset.index));
                }
                return;
            }
            
            if (addSubBtn) {
                e.stopPropagation();
                if (typeof window.addSubFunction === 'function') {
                    window.addSubFunction(parseInt(addSubBtn.dataset.index));
                }
                return;
            }
            
            if (link) {
                // Let link work normally
                return;
            }
            
            // Connection mode
            if (window.currentTool === 'connect') {
                e.preventDefault();
                e.stopPropagation();
                handleConnectionClick(card, index);
            }
        });
        
        // Mouse drag handling
        card.addEventListener('mousedown', (e) => {
            if (e.target.closest('.action-btn, .plus-btn, .field-link')) return;
            if (window.currentTool !== 'select') return;
            
            startDrag(card, e.clientX, e.clientY);
            e.preventDefault();
        });

        // Touch drag handling
        card.addEventListener('touchstart', (e) => {
            if (e.target.closest('.action-btn, .plus-btn, .field-link')) return;
            if (window.currentTool !== 'select') return;
            if (e.touches.length !== 1) return;

            const touch = e.touches[0];
            startDrag(card, touch.clientX, touch.clientY);
            // Don't prevent default to allow scrolling
        }, { passive: true });
    }

    function startDrag(card, clientX, clientY) {
        dragState.isDragging = true;
        dragState.currentCard = card;
        dragState.startX = clientX;
        dragState.startY = clientY;
        dragState.initialX = card.offsetLeft;
        dragState.initialY = card.offsetTop;
        
        card.classList.add('dragging');
    }

    function handleConnectionClick(card, index) {
        if (window.connectingFrom === null) {
            window.connectingFrom = index;
            card.classList.add('connecting');
            
            document.querySelectorAll('.function-card').forEach((c, i) => {
                if (i !== index) {
                    c.classList.add('connect-target');
                    c.style.opacity = '0.8';
                }
            });
        } else if (window.connectingFrom !== index) {
            // Check if connection already exists
            const exists = window.connections.find(conn => 
                conn.from === window.connectingFrom && conn.to === index
            );
            
            if (!exists) {
                window.connections.push({ from: window.connectingFrom, to: index });
                if (typeof window.debouncedSave === 'function') {
                    window.debouncedSave();
                }
                renderConnections();
            }
            
            clearConnectionMode();
        } else {
            // Clicked same card - cancel
            clearConnectionMode();
        }
    }

    function clearConnectionMode() {
        window.connectingFrom = null;
        document.querySelectorAll('.function-card').forEach(c => {
            c.classList.remove('connecting', 'connect-target');
            c.style.opacity = '';
        });
    }

    // Global mouse handlers for dragging
    document.addEventListener('mousemove', (e) => {
        if (!dragState.isDragging || !dragState.currentCard) return;
        handleDragMove(e.clientX, e.clientY);
    });

    document.addEventListener('mouseup', () => {
        endDrag();
    });

    // Global touch handlers for dragging
    document.addEventListener('touchmove', (e) => {
        if (!dragState.isDragging || !dragState.currentCard) return;
        if (e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        handleDragMove(touch.clientX, touch.clientY);
        e.preventDefault(); // Prevent scroll while dragging
    }, { passive: false });

    document.addEventListener('touchend', () => {
        endDrag();
    });

    document.addEventListener('touchcancel', () => {
        endDrag();
    });

    function handleDragMove(clientX, clientY) {
        const scale = window.scale || 1;
        const deltaX = (clientX - dragState.startX) / scale;
        const deltaY = (clientY - dragState.startY) / scale;
        
        const newX = Math.max(0, dragState.initialX + deltaX);
        const newY = Math.max(0, dragState.initialY + deltaY);
        
        dragState.currentCard.style.left = newX + 'px';
        dragState.currentCard.style.top = newY + 'px';
        
        const index = parseInt(dragState.currentCard.dataset.index);
        if (window.functions && window.functions[index]) {
            window.functions[index].x = newX;
            window.functions[index].y = newY;
            window.functions[index].modified = new Date().toISOString();
        }
        
        // Throttled connection update
        if (!dragState.renderPending) {
            dragState.renderPending = true;
            requestAnimationFrame(() => {
                renderConnections();
                dragState.renderPending = false;
            });
        }
    }

    function endDrag() {
        if (dragState.isDragging && dragState.currentCard) {
            dragState.currentCard.classList.remove('dragging');
            if (typeof window.debouncedSave === 'function') {
                window.debouncedSave();
            }
        }
        
        dragState.isDragging = false;
        dragState.currentCard = null;
    }

    function renderConnections() {
        const svg = document.getElementById('connections');
        if (!svg) return;
        
        const canvas = document.getElementById('canvas');
        if (!canvas) return;
        
        // Clear existing
        svg.innerHTML = `
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary-color)" />
                </marker>
            </defs>
        `;
        
        if (!window.connections || window.connections.length === 0) return;
        
        const scale = window.scale || 1;
        const canvasRect = canvas.getBoundingClientRect();
        
        window.connections.forEach((conn, connIndex) => {
            const fromNode = document.querySelector(`[data-index="${conn.from}"]`);
            const toNode = document.querySelector(`[data-index="${conn.to}"]`);
            
            if (!fromNode || !toNode) return;
            
            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            
            const fromX = (fromRect.left + fromRect.width / 2 - canvasRect.left) / scale;
            const fromY = (fromRect.bottom - canvasRect.top) / scale;
            const toX = (toRect.left + toRect.width / 2 - canvasRect.left) / scale;
            const toY = (toRect.top - canvasRect.top) / scale;
            
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.style.cursor = 'pointer';
            group.style.pointerEvents = 'all';
            
            // Bezier curve path
            const controlY = fromY + (toY - fromY) / 2;
            const pathD = `M ${fromX} ${fromY} Q ${fromX} ${controlY} ${toX} ${toY}`;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathD);
            path.setAttribute('stroke', 'var(--primary-color)');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#arrowhead)');
            path.style.pointerEvents = 'none';
            path.style.transition = 'stroke 0.2s, stroke-width 0.2s';
            
            // Invisible click area
            const clickArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            clickArea.setAttribute('d', pathD);
            clickArea.setAttribute('stroke', 'transparent');
            clickArea.setAttribute('stroke-width', '20');
            clickArea.setAttribute('fill', 'none');
            clickArea.style.cursor = 'pointer';
            
            // Hover effects
            group.addEventListener('mouseenter', () => {
                path.setAttribute('stroke', 'var(--danger-color)');
                path.setAttribute('stroke-width', '3');
            });
            
            group.addEventListener('mouseleave', () => {
                path.setAttribute('stroke', 'var(--primary-color)');
                path.setAttribute('stroke-width', '2');
            });
            
            // Delete connection on click
            group.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                const t = window.t || ((k) => k);
                const fromName = window.functions[conn.from]?.name || '';
                const toName = window.functions[conn.to]?.name || '';
                
                const message = t('prompt.delete_connection')
                    .replace('%s', fromName)
                    .replace('%s', toName);
                
                if (confirm(message)) {
                    window.connections.splice(connIndex, 1);
                    if (typeof window.debouncedSave === 'function') {
                        window.debouncedSave();
                    }
                    renderConnections();
                }
            });
            
            group.appendChild(clickArea);
            group.appendChild(path);
            svg.appendChild(group);
        });
    }

    // === CANVAS PANNING & ZOOM ===
    function setupCanvasPanning() {
        const container = document.getElementById('canvasContainer');
        if (!container) return;
        
        let isPanning = false;
        let lastPanPoint = null;
        
        // === MOUSE EVENTS ===
        container.addEventListener('mousedown', (e) => {
            if (e.target.closest('.function-card')) return;
            
            if (window.currentTool === 'hand') {
                isPanning = true;
                lastPanPoint = { x: e.clientX, y: e.clientY };
                container.classList.add('panning');
                e.preventDefault();
            }
        });
        
        container.addEventListener('mousemove', (e) => {
            if (!isPanning || !lastPanPoint) return;
            
            const deltaX = e.clientX - lastPanPoint.x;
            const deltaY = e.clientY - lastPanPoint.y;
            
            window.panX = (window.panX || 0) + deltaX;
            window.panY = (window.panY || 0) + deltaY;
            
            updateCanvasTransform();
            lastPanPoint = { x: e.clientX, y: e.clientY };
        });
        
        container.addEventListener('mouseup', () => {
            isPanning = false;
            lastPanPoint = null;
            container.classList.remove('panning');
        });
        
        container.addEventListener('mouseleave', () => {
            isPanning = false;
            lastPanPoint = null;
            container.classList.remove('panning');
        });
        
        // Mouse wheel zoom
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            window.scale = Math.max(0.1, Math.min(3, (window.scale || 1) * delta));
            updateCanvasTransform();
        }, { passive: false });

        // === TOUCH EVENTS ===
        let touchStartDistance = 0;
        let touchStartScale = 1;
        let touchStartPan = { x: 0, y: 0 };
        let lastTouchPoint = null;
        let isTouchPanning = false;
        let isPinching = false;

        container.addEventListener('touchstart', (e) => {
            if (e.target.closest('.function-card')) return;

            if (e.touches.length === 2) {
                // Pinch-to-zoom start (works in any tool mode)
                isPinching = true;
                isTouchPanning = true; // Enable pan during pinch
                touchStartDistance = getTouchDistance(e.touches);
                touchStartScale = window.scale || 1;
                
                // Calculate center point for pinch
                const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                lastTouchPoint = { x: centerX, y: centerY };
                
                e.preventDefault();
            } else if (e.touches.length === 1) {
                // Single finger pan (only in hand tool mode)
                if (window.currentTool === 'hand') {
                    isTouchPanning = true;
                    lastTouchPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    touchStartPan = { x: window.panX || 0, y: window.panY || 0 };
                    container.classList.add('panning');
                }
            }
        }, { passive: false });

        container.addEventListener('touchmove', (e) => {
            if (e.target.closest('.function-card')) return;

            if (isPinching && e.touches.length === 2) {
                // Pinch-to-zoom + pan
                e.preventDefault();
                
                // Zoom
                const currentDistance = getTouchDistance(e.touches);
                const scaleChange = currentDistance / touchStartDistance;
                window.scale = Math.max(0.1, Math.min(3, touchStartScale * scaleChange));
                
                // Pan during pinch
                const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                
                if (lastTouchPoint) {
                    window.panX = (window.panX || 0) + (centerX - lastTouchPoint.x);
                    window.panY = (window.panY || 0) + (centerY - lastTouchPoint.y);
                }
                
                lastTouchPoint = { x: centerX, y: centerY };
                updateCanvasTransform();
            } else if (isTouchPanning && e.touches.length === 1 && lastTouchPoint) {
                // Single finger pan
                e.preventDefault();
                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouchPoint.x;
                const deltaY = touch.clientY - lastTouchPoint.y;
                
                window.panX = (window.panX || 0) + deltaX;
                window.panY = (window.panY || 0) + deltaY;
                
                updateCanvasTransform();
                lastTouchPoint = { x: touch.clientX, y: touch.clientY };
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (e.touches.length === 0) {
                isPinching = false;
                isTouchPanning = false;
                lastTouchPoint = null;
                container.classList.remove('panning');
            } else if (e.touches.length === 1 && isPinching) {
                // Switched from pinch to single touch
                isPinching = false;
                if (window.currentTool === 'hand') {
                    isTouchPanning = true;
                    lastTouchPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }
        });

        container.addEventListener('touchcancel', () => {
            isPinching = false;
            isTouchPanning = false;
            lastTouchPoint = null;
            container.classList.remove('panning');
        });
    }

    // Helper function for pinch distance
    function getTouchDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    function updateCanvasTransform() {
        const canvas = document.getElementById('canvas');
        if (!canvas) return;
        
        const scale = window.scale || 1;
        const panX = window.panX || 0;
        const panY = window.panY || 0;
        
        canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        
        // Update zoom level display
        if (typeof window.updateZoomLevel === 'function') {
            window.updateZoomLevel();
        }
    }

    function zoomIn() {
        window.scale = Math.min(3, (window.scale || 1) * 1.2);
        updateCanvasTransform();
    }

    function zoomOut() {
        window.scale = Math.max(0.1, (window.scale || 1) / 1.2);
        updateCanvasTransform();
    }

    function zoomToFit() {
        if (!window.functions || window.functions.length === 0) return;
        
        const funcs = window.functions;
        const minX = Math.min(...funcs.map(f => f.x || 0));
        const maxX = Math.max(...funcs.map(f => (f.x || 0) + 280));
        const minY = Math.min(...funcs.map(f => f.y || 0));
        const maxY = Math.max(...funcs.map(f => (f.y || 0) + 220));
        
        const padding = 100;
        const bounds = {
            x: minX - padding,
            y: minY - padding,
            width: maxX - minX + (padding * 2),
            height: maxY - minY + (padding * 2)
        };
        
        const container = document.getElementById('canvasContainer');
        if (!container) return;
        
        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;
        
        const scaleX = containerWidth / bounds.width;
        const scaleY = containerHeight / bounds.height;
        window.scale = Math.min(scaleX, scaleY, 1) * 0.85;
        
        window.panX = (containerWidth - bounds.width * window.scale) / 2 - bounds.x * window.scale;
        window.panY = (containerHeight - bounds.height * window.scale) / 2 - bounds.y * window.scale;
        
        updateCanvasTransform();
    }

    // === BACKUP/DEBUG FUNCTIONS ===
    function listBackups() {
        if (!window.currentUser) {
            console.log('[ERR] Користувач не авторизований');
            return;
        }
        
        console.log('[COPY] Завантаження бекапів...');
        
        firebase.firestore().collection('users').doc(window.currentUser.uid)
            .collection('backups').orderBy('timestamp', 'desc').limit(10).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    console.log('[EMPTY] Бекапів не знайдено');
                    return;
                }
                
                console.log('[COPY] БЕКАПИ:', snapshot.size);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`  📁 ${doc.id}:`, {
                        date: data.timestamp,
                        version: data.version,
                        functions: data.structure?.functions?.length || 0
                    });
                });
                
                console.log('[TIP] Відновлення: restoreFromBackup("backup_id")');
            })
            .catch(error => console.error('[ERR] Помилка:', error));
    }

    function restoreFromBackup(backupId) {
        if (!window.currentUser || !backupId) {
            console.log('[ERR] Потрібен userId та backupId');
            return;
        }
        
        console.log('[RESTORE] Відновлення з:', backupId);
        
        firebase.firestore().collection('users').doc(window.currentUser.uid)
            .collection('backups').doc(backupId).get()
            .then(doc => {
                if (!doc.exists) {
                    console.log('[ERR] Бекап не знайдено');
                    return;
                }
                
                const data = doc.data();
                if (data.structure) {
                    window.functions = data.structure.functions || [];
                    window.connections = data.structure.connections || [];
                    
                    renderFunctions();
                    if (typeof window.debouncedSave === 'function') {
                        window.debouncedSave();
                    }
                    
                    console.log('[OK] Відновлено:', window.functions.length, 'функцій');
                    window.showNotification ? window.showNotification('Відновлено з бекапу', 'success') : null;
                }
            })
            .catch(error => console.error('[ERR] Помилка:', error));
    }

    // === INITIALIZATION ===
    async function init() {
        console.log('[START] TALKO System v3.3 Block 3 initializing...');
        
        await waitForDependencies();
        
        setupCanvasPanning();
        
        // Initial zoom level display
        if (typeof window.updateZoomLevel === 'function') {
            window.updateZoomLevel();
        }

        // Auto-select hand tool on touch devices for better UX
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice && typeof window.setTool === 'function') {
            // Keep select tool but enable two-finger pan
            console.log('[TOUCH] Touch device detected');
        }

        // Auto zoom-to-fit on mobile after data loads
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                if (window.functions && window.functions.length > 0) {
                    zoomToFit();
                }
            }, 500);
        }
        
        console.log('[OK] TALKO System v3.3 Block 3 ready!');
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // === EXPORT TO GLOBAL SCOPE ===
    window.copyStructure = copyStructure;
    window.pasteStructure = pasteStructure;
    window.renderFunctions = renderFunctions;
    window.renderConnections = renderConnections;
    window.zoomIn = zoomIn;
    window.zoomOut = zoomOut;
    window.zoomToFit = zoomToFit;
    window.exportToJPEG = exportToJPEG;
    window.exportToPDF = exportToPDF;
    window.exportToExcel = exportToExcel;
    window.showBackupModal = showBackupModal;
    window.closeBackupModal = closeBackupModal;
    window.restoreBackup = restoreBackup;
    window.listBackups = listBackups;
    window.restoreFromBackup = restoreFromBackup;
    window.updateCanvasTransform = updateCanvasTransform;

})();
</script>

</body>
</html>
