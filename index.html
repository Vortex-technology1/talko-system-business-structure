<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TALKO Clients Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <style>
    [x-cloak] { display: none !important; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #22c55e; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAOmGZTwlC820Eh7axijcIFt0SPCmpEquc",
      authDomain: "talko-clients-tracker.firebaseapp.com",
      projectId: "talko-clients-tracker",
      storageBucket: "talko-clients-tracker.firebasestorage.app",
      messagingSenderId: "1048160665282",
      appId: "1:1048160665282:web:c28486793cfc6bc0a3455b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // State
    let currentUser = null;
    let clients = [];
    let expenses = [];
    let exchangeRates = { USD: 0.92, UAH: 0.024 };
    let activeTab = 'journal';
    let showAddForm = false;
    let showExpenseForm = false;
    let editingClient = null;
    let editingExpense = null;
    let unsubClients = null;
    let unsubExpenses = null;

    const serviceTypes = [
      { value: 'consulting_self', label: '–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ —Å–∞–º–æ—Å—Ç—ñ–π–Ω–∏–π', months: 3 },
      { value: 'consulting_group', label: '–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –≤ –≥—Ä—É–ø—ñ', months: 3 },
      { value: 'consulting_individual', label: '–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π', months: 1 },
      { value: 'subscription_updates', label: '–ü—ñ–¥–ø–∏—Å–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', months: 1 },
      { value: 'subscription_group', label: '–ü—ñ–¥–ø–∏—Å–∫–∞ –≥—Ä—É–ø–∞', months: 1 },
      { value: 'subscription_platform', label: '–ü—ñ–¥–ø–∏—Å–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏', months: 1 },
      { value: 'support_1h', label: '–í–µ–¥–µ–Ω–Ω—è 1 –≥–æ–¥/—Ç–∏–∂–¥', months: 1 },
      { value: 'support_2h', label: '–í–µ–¥–µ–Ω–Ω—è 2 –≥–æ–¥/—Ç–∏–∂–¥', months: 1 },
      { value: 'marketing_self', label: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ —Å–∞–º–æ—Å—Ç—ñ–π–Ω–∏–π', months: 2 },
      { value: 'marketing_support', label: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∑ —Å—É–ø—Ä–æ–≤–æ–¥–æ–º', months: 2 },
    ];

    const expenseCategories = [
      { value: 'services', label: '–°–µ—Ä–≤—ñ—Å–∏/–ü—ñ–¥–ø–∏—Å–∫–∏', color: 'bg-blue-100 text-blue-800' },
      { value: 'ads', label: '–†–µ–∫–ª–∞–º–∞', color: 'bg-orange-100 text-orange-800' },
      { value: 'taxes', label: '–ü–æ–¥–∞—Ç–∫–∏', color: 'bg-red-100 text-red-800' },
      { value: 'other', label: '–Ü–Ω—à–µ', color: 'bg-gray-100 text-gray-800' },
    ];

    const currencies = [
      { value: 'EUR', symbol: '‚Ç¨' },
      { value: 'USD', symbol: '$' },
      { value: 'UAH', symbol: '‚Ç¥' },
    ];

    // Helpers
    const addMonths = (date, months) => {
      const result = new Date(date);
      result.setMonth(result.getMonth() + months);
      return result;
    };

    const formatDate = (date) => {
      if (!date) return '';
      const d = new Date(date);
      return d.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };

    const getMonthYear = (dateStr) => {
      const d = new Date(dateStr);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    };

    const getMonthLabel = (monthKey) => {
      const [year, month] = monthKey.split('-');
      const months = ['–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å', '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'];
      return `${months[parseInt(month) - 1]} ${year}`;
    };

    const getMonthLabelShort = (monthKey) => {
      const [year, month] = monthKey.split('-');
      const months = ['–°—ñ—á', '–õ—é—Ç', '–ë–µ—Ä', '–ö–≤—ñ', '–¢—Ä–∞', '–ß–µ—Ä', '–õ–∏–ø', '–°–µ—Ä', '–í–µ—Ä', '–ñ–æ–≤', '–õ–∏—Å', '–ì—Ä—É'];
      return `${months[parseInt(month) - 1]} ${year.slice(2)}`;
    };

    const getCurrentMonth = () => {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    };

    const getEndDate = (startDate, serviceType) => {
      if (!startDate || !serviceType) return null;
      const service = serviceTypes.find(s => s.value === serviceType);
      if (!service) return null;
      return addMonths(new Date(startDate), service.months);
    };

    const getStatus = (row) => {
      const today = new Date();
      today.setHours(0,0,0,0);
      const start = new Date(row.startDate);
      start.setHours(0,0,0,0);
      const endDate = getEndDate(row.startDate, row.serviceType);
      if (start > today) return 'deposit';
      if (endDate) {
        const end = new Date(endDate);
        end.setHours(0,0,0,0);
        if (today <= end) return 'active';
      }
      return 'completed';
    };

    const getStatusLabel = (status) => {
      switch(status) {
        case 'deposit': return { label: '–ó–∞–≤–¥–∞—Ç–æ–∫', class: 'bg-purple-100 text-purple-800' };
        case 'active': return { label: '–ê–∫—Ç–∏–≤–Ω–∏–π', class: 'bg-green-100 text-green-800' };
        case 'completed': return { label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', class: 'bg-gray-100 text-gray-600' };
        default: return { label: '', class: '' };
      }
    };

    const toEUR = (amount, currency) => {
      if (currency === 'EUR') return amount;
      const rate = currency === 'USD' ? exchangeRates.USD : exchangeRates.UAH;
      return amount * rate;
    };

    const formatCurrency = (amount, currency) => {
      const curr = currencies.find(c => c.value === currency);
      return `${curr?.symbol || ''}${amount}`;
    };

    // Firebase Operations
    const subscribeToData = (userId) => {
      // Clients
      const clientsRef = collection(db, 'users', userId, 'clients');
      const clientsQuery = query(clientsRef, orderBy('startDate', 'desc'));
      unsubClients = onSnapshot(clientsQuery, (snapshot) => {
        clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // Expenses
      const expensesRef = collection(db, 'users', userId, 'expenses');
      const expensesQuery = query(expensesRef, orderBy('month', 'desc'));
      unsubExpenses = onSnapshot(expensesQuery, (snapshot) => {
        expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      });

      // Settings
      const settingsRef = doc(db, 'users', userId, 'settings', 'exchangeRates');
      getDoc(settingsRef).then(docSnap => {
        if (docSnap.exists()) {
          exchangeRates = docSnap.data();
          render();
        }
      });
    };

    const addClient = async (data) => {
      if (!currentUser) return;
      const clientsRef = collection(db, 'users', currentUser.uid, 'clients');
      await addDoc(clientsRef, { ...data, createdAt: new Date().toISOString() });
    };

    const updateClient = async (id, data) => {
      if (!currentUser) return;
      const clientRef = doc(db, 'users', currentUser.uid, 'clients', id);
      await updateDoc(clientRef, data);
    };

    const deleteClient = async (id) => {
      if (!currentUser) return;
      const clientRef = doc(db, 'users', currentUser.uid, 'clients', id);
      await deleteDoc(clientRef);
    };

    const addExpense = async (data) => {
      if (!currentUser) return;
      const expensesRef = collection(db, 'users', currentUser.uid, 'expenses');
      await addDoc(expensesRef, { ...data, createdAt: new Date().toISOString() });
    };

    const updateExpense = async (id, data) => {
      if (!currentUser) return;
      const expenseRef = doc(db, 'users', currentUser.uid, 'expenses', id);
      await updateDoc(expenseRef, data);
    };

    const deleteExpense = async (id) => {
      if (!currentUser) return;
      const expenseRef = doc(db, 'users', currentUser.uid, 'expenses', id);
      await deleteDoc(expenseRef);
    };

    const saveExchangeRates = async () => {
      if (!currentUser) return;
      const settingsRef = doc(db, 'users', currentUser.uid, 'settings', 'exchangeRates');
      await setDoc(settingsRef, exchangeRates);
    };

    // Auth
    const handleSignIn = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error('Sign in error:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + error.message);
      }
    };

    const handleSignOut = async () => {
      if (unsubClients) unsubClients();
      if (unsubExpenses) unsubExpenses();
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        subscribeToData(user.uid);
      } else {
        clients = [];
        expenses = [];
      }
      render();
    });

    // Icons
    const icons = {
      logo: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
      journal: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>`,
      users: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 11a4 4 0 100-8 4 4 0 000 8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>`,
      profit: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>`,
      chart: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>`,
      plus: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`,
      edit: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
      trash: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>`,
      close: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>`,
      calendar: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>`,
      wallet: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2zM1 10h22"/></svg>`,
      clock: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
      arrowUp: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>`,
      arrowDown: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>`,
      google: `<svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>`,
      ai: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/><circle cx="9" cy="13" r="1"/><circle cx="15" cy="13" r="1"/><path d="M9 17h6"/></svg>`,
      logout: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>`,
      refresh: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>`,
    };

    // Render Functions
    const renderLoginPage = () => `
      <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
          <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-white mx-auto mb-6">
            ${icons.logo}
          </div>
          <h1 class="text-2xl font-bold text-gray-800 mb-2">TALKO Clients Tracker</h1>
          <p class="text-gray-500 mb-8">–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ –ø—Ä–∏–±—É—Ç–∫—É</p>
          <button onclick="window.handleSignIn()" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-white border-2 border-gray-200 rounded-xl font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition">
            ${icons.google}
            –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>
          <p class="text-xs text-gray-400 mt-6">–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –≤–∞—à–æ–º—É Firebase –∞–∫–∞—É–Ω—Ç—ñ</p>
        </div>
      </div>
    `;

    const renderHeader = () => {
      const totalPaid = clients.reduce((sum, c) => sum + (c.paid || 0), 0);
      const totalExpenses = expenses.reduce((sum, e) => sum + toEUR(e.amount, e.currency), 0);
      const totalProfit = totalPaid - totalExpenses;

      return `
        <header class="bg-white shadow-sm sticky top-0 z-40">
          <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white">${icons.logo}</div>
                <h1 class="text-xl font-bold text-gray-800">TALKO Clients</h1>
              </div>
              <div class="flex items-center gap-4 text-sm">
                <span class="text-gray-500">–î–æ—Ö—ñ–¥: <b class="text-green-600">‚Ç¨${totalPaid.toLocaleString()}</b></span>
                <span class="text-gray-500">–í–∏—Ç—Ä–∞—Ç–∏: <b class="text-red-500">‚Ç¨${Math.round(totalExpenses).toLocaleString()}</b></span>
                <span class="font-bold ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">‚Ç¨${Math.round(totalProfit).toLocaleString()}</span>
                <div class="flex items-center gap-2 ml-2 pl-2 border-l">
                  <img src="${currentUser?.photoURL}" class="w-6 h-6 rounded-full" alt="">
                  <button onclick="window.handleSignOut()" class="p-1 text-gray-400 hover:text-red-500" title="–í–∏–π—Ç–∏">${icons.logout}</button>
                </div>
              </div>
            </div>
          </div>
        </header>
      `;
    };

    const renderAlerts = () => {
      const today = new Date();
      today.setHours(0,0,0,0);
      const weekLater = new Date(today);
      weekLater.setDate(weekLater.getDate() + 7);

      const deposits = clients.filter(c => getStatus(c) === 'deposit');
      const expiring = clients.filter(c => {
        if (getStatus(c) !== 'active') return false;
        const endDate = getEndDate(c.startDate, c.serviceType);
        if (!endDate) return false;
        const end = new Date(endDate);
        return end >= today && end <= weekLater;
      });

      let html = '';

      if (deposits.length > 0) {
        html += `
          <div class="mb-4 bg-purple-50 border border-purple-200 rounded-xl p-4">
            <h2 class="text-sm font-bold text-purple-800 mb-2 flex items-center gap-2">${icons.wallet} –ß–µ–∫–∞—é—Ç—å –Ω–∞ —Å—Ç–∞—Ä—Ç (${deposits.length})</h2>
            <div class="flex flex-wrap gap-2">
              ${deposits.map(c => `
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-purple-100 text-sm">
                  <span class="font-medium">${c.name}</span>
                  <span class="text-gray-400">‚Ä¢</span>
                  <span class="text-gray-500">—Å—Ç–∞—Ä—Ç ${formatDate(c.startDate)}</span>
                  <span class="text-purple-600 font-medium">‚Ç¨${c.paid} –∑ ‚Ç¨${c.contractSum}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (expiring.length > 0) {
        html += `
          <div class="mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4">
            <h2 class="text-sm font-bold text-amber-800 mb-2 flex items-center gap-2">${icons.clock} –ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è (${expiring.length})</h2>
            <div class="flex flex-wrap gap-2">
              ${expiring.map(c => `
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-amber-100 text-sm">
                  <span class="font-medium">${c.name}</span>
                  <span class="text-gray-400">‚Ä¢</span>
                  <span class="text-gray-500">${formatDate(getEndDate(c.startDate, c.serviceType))}</span>
                  ${c.repeats ? '<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">–∞–≤—Ç–æ</span>' : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      return html;
    };

    const renderTabs = () => `
      <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
        ${[
          { id: 'journal', icon: icons.journal, label: '–ñ—É—Ä–Ω–∞–ª' },
          { id: 'clients', icon: icons.users, label: '–ö–ª—ñ—î–Ω—Ç–∏' },
          { id: 'profit', icon: icons.profit, label: '–ü—Ä–∏–±—É—Ç–æ–∫' },
          { id: 'analytics', icon: icons.chart, label: '–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞' },
        ].map(tab => `
          <button onclick="window.setTab('${tab.id}')" class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition flex items-center gap-2 ${activeTab === tab.id ? 'bg-green-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}">
            ${tab.icon} ${tab.label}
          </button>
        `).join('')}
        <button onclick="window.openAddClient()" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition flex items-center gap-2">
          ${icons.plus} –ö–ª—ñ—î–Ω—Ç
        </button>
        <a href="https://chatgpt.com/g/g-693dacab46dc8191ba92badb3079df58-talko-clients-treker" target="_blank" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg font-medium hover:from-emerald-600 hover:to-teal-600 transition flex items-center gap-2">
          ${icons.ai} AI
        </a>
        <button onclick="window.generateNextMonth()" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600 transition flex items-center gap-2" title="–ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –º—ñ—Å—è—Ü—å">
          ${icons.refresh}
        </button>
      </div>
    `;

    const renderJournal = () => {
      const groups = {};
      clients.forEach(c => {
        const key = getMonthYear(c.startDate);
        if (!groups[key]) groups[key] = [];
        groups[key].push(c);
      });
      const sorted = Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
      const colors = ['bg-red-50', 'bg-amber-50', 'bg-green-50', 'bg-blue-50', 'bg-purple-50'];

      if (sorted.length === 0) {
        return '<div class="bg-white rounded-xl p-8 text-center text-gray-500">–ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤. –ù–∞—Ç–∏—Å–Ω–∏ "+ –ö–ª—ñ—î–Ω—Ç" —â–æ–± –¥–æ–¥–∞—Ç–∏.</div>';
      }

      return sorted.map(([monthKey, rows], idx) => {
        const totals = { contract: 0, paid: 0 };
        rows.forEach(r => { totals.contract += r.contractSum || 0; totals.paid += r.paid || 0; });

        return `
          <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
            <div class="${colors[idx % colors.length]} px-4 py-3 flex flex-wrap items-center justify-between gap-2">
              <h3 class="font-bold text-gray-800 flex items-center gap-2">${icons.calendar} ${getMonthLabel(monthKey)}</h3>
              <div class="flex gap-4 text-sm">
                <span>–î–æ–≥–æ–≤–æ—Ä–∏: <b>‚Ç¨${totals.contract.toLocaleString()}</b></span>
                <span>–û–ø–ª–∞—á–µ–Ω–æ: <b class="text-green-600">‚Ç¨${totals.paid.toLocaleString()}</b></span>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                  <tr>
                    <th class="px-4 py-2 text-left">–ö–ª—ñ—î–Ω—Ç</th>
                    <th class="px-4 py-2 text-center">–°—Ç–∞—Ç—É—Å</th>
                    <th class="px-4 py-2 text-center">–°—Ç–∞—Ä—Ç</th>
                    <th class="px-4 py-2 text-left hidden md:table-cell">–ü–æ—Å–ª—É–≥–∞</th>
                    <th class="px-4 py-2 text-center hidden md:table-cell">–ó–∞–∫—ñ–Ω—á.</th>
                    <th class="px-4 py-2 text-right">–î–æ–≥–æ–≤—ñ—Ä</th>
                    <th class="px-4 py-2 text-right">–û–ø–ª–∞—á–µ–Ω–æ</th>
                    <th class="px-4 py-2 text-center">–î—ñ—ó</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  ${rows.map(c => {
                    const status = getStatus(c);
                    const statusInfo = getStatusLabel(status);
                    const service = serviceTypes.find(s => s.value === c.serviceType);
                    const endDate = getEndDate(c.startDate, c.serviceType);
                    return `
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${c.name}</td>
                        <td class="px-4 py-3 text-center"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusInfo.class}">${statusInfo.label}</span></td>
                        <td class="px-4 py-3 text-center text-sm">${formatDate(c.startDate)}</td>
                        <td class="px-4 py-3 text-sm hidden md:table-cell">${service?.label || ''}</td>
                        <td class="px-4 py-3 text-center text-sm hidden md:table-cell">${formatDate(endDate)}</td>
                        <td class="px-4 py-3 text-right">‚Ç¨${c.contractSum}</td>
                        <td class="px-4 py-3 text-right text-green-600">‚Ç¨${c.paid}</td>
                        <td class="px-4 py-3 text-center">
                          <button onclick="window.editClient('${c.id}')" class="p-1.5 text-gray-400 hover:text-blue-500">${icons.edit}</button>
                          <button onclick="window.removeClient('${c.id}')" class="p-1.5 text-gray-400 hover:text-red-500">${icons.trash}</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    };

    const renderClients = () => {
      const clientMap = {};
      clients.forEach(c => {
        if (!clientMap[c.name]) clientMap[c.name] = { name: c.name, totalPaid: 0, totalContract: 0, periods: 0, isActive: false };
        clientMap[c.name].totalPaid += c.paid || 0;
        clientMap[c.name].totalContract += c.contractSum || 0;
        clientMap[c.name].periods += 1;
        const status = getStatus(c);
        if (status === 'active' || status === 'deposit') clientMap[c.name].isActive = true;
      });
      const summary = Object.values(clientMap).sort((a, b) => b.totalPaid - a.totalPaid);

      if (summary.length === 0) {
        return '<div class="bg-white rounded-xl p-8 text-center text-gray-500">–ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤</div>';
      }

      return `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
              <tr>
                <th class="px-4 py-3 text-left">–ö–ª—ñ—î–Ω—Ç</th>
                <th class="px-4 py-3 text-center">–°—Ç–∞—Ç—É—Å</th>
                <th class="px-4 py-3 text-center">–ü–µ—Ä—ñ–æ–¥—ñ–≤</th>
                <th class="px-4 py-3 text-right">–î–æ–≥–æ–≤–æ—Ä—ñ–≤</th>
                <th class="px-4 py-3 text-right">–û–ø–ª–∞—á–µ–Ω–æ</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              ${summary.map(c => `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-medium">${c.name}</td>
                  <td class="px-4 py-3 text-center">
                    ${c.isActive ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">–ê–∫—Ç–∏–≤–Ω–∏–π</span>' : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">–ó–∞–≤–µ—Ä—à–∏–≤</span>'}
                  </td>
                  <td class="px-4 py-3 text-center">${c.periods}</td>
                  <td class="px-4 py-3 text-right">‚Ç¨${c.totalContract.toLocaleString()}</td>
                  <td class="px-4 py-3 text-right font-medium text-green-600">‚Ç¨${c.totalPaid.toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot class="bg-gray-50 font-bold">
              <tr>
                <td class="px-4 py-3">–í—Å—å–æ–≥–æ: ${summary.length}</td>
                <td class="px-4 py-3 text-center">${summary.filter(c => c.isActive).length} –∞–∫—Ç–∏–≤–Ω–∏—Ö</td>
                <td class="px-4 py-3"></td>
                <td class="px-4 py-3 text-right">‚Ç¨${summary.reduce((s, c) => s + c.totalContract, 0).toLocaleString()}</td>
                <td class="px-4 py-3 text-right text-green-600">‚Ç¨${summary.reduce((s, c) => s + c.totalPaid, 0).toLocaleString()}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };

    const renderProfit = () => {
      const profitMap = {};
      clients.forEach(c => {
        const month = getMonthYear(c.startDate);
        if (!profitMap[month]) profitMap[month] = { month, income: 0, expenses: 0, expensesList: [] };
        profitMap[month].income += c.paid || 0;
      });
      expenses.forEach(e => {
        const month = e.month;
        if (!profitMap[month]) profitMap[month] = { month, income: 0, expenses: 0, expensesList: [] };
        const amountEUR = toEUR(e.amount, e.currency);
        profitMap[month].expenses += amountEUR;
        profitMap[month].expensesList.push({ ...e, amountEUR });
      });
      const profitByMonth = Object.values(profitMap).map(m => ({ ...m, profit: m.income - m.expenses })).sort((a, b) => b.month.localeCompare(a.month));

      const totalIncome = clients.reduce((s, c) => s + (c.paid || 0), 0);
      const totalExpenses = expenses.reduce((s, e) => s + toEUR(e.amount, e.currency), 0);
      const totalProfit = totalIncome - totalExpenses;

      return `
        <div class="space-y-4">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <div class="flex flex-wrap items-center gap-4">
              <span class="text-sm font-medium text-gray-700">–ö—É—Ä—Å –¥–æ EUR:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm">$1 =</span>
                <input type="number" step="0.01" value="${exchangeRates.USD}" onchange="window.updateRate('USD', this.value)" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                <span class="text-sm">‚Ç¨</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm">‚Ç¥1 =</span>
                <input type="number" step="0.001" value="${exchangeRates.UAH}" onchange="window.updateRate('UAH', this.value)" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                <span class="text-sm">‚Ç¨</span>
              </div>
              <button onclick="window.openAddExpense()" class="ml-auto px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition flex items-center gap-2">
                ${icons.plus} –í–∏—Ç—Ä–∞—Ç–∞
              </button>
            </div>
          </div>

          ${profitByMonth.map(month => `
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
              <div class="px-4 py-3 bg-gray-50 flex flex-wrap items-center justify-between gap-2">
                <h3 class="font-bold text-gray-800">${getMonthLabel(month.month)}</h3>
                <div class="flex gap-4 text-sm">
                  <span class="flex items-center gap-1 text-green-600">${icons.arrowUp} ‚Ç¨${Math.round(month.income).toLocaleString()}</span>
                  <span class="flex items-center gap-1 text-red-500">${icons.arrowDown} ‚Ç¨${Math.round(month.expenses).toLocaleString()}</span>
                  <span class="font-bold ${month.profit >= 0 ? 'text-green-600' : 'text-red-600'}">= ‚Ç¨${Math.round(month.profit).toLocaleString()}</span>
                </div>
              </div>
              ${month.expensesList.length > 0 ? `
                <div class="p-4">
                  <div class="text-xs font-medium text-gray-500 uppercase mb-2">–í–∏—Ç—Ä–∞—Ç–∏</div>
                  <div class="space-y-2">
                    ${month.expensesList.map(e => {
                      const cat = expenseCategories.find(c => c.value === e.category);
                      return `
                        <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg">
                          <div class="flex items-center gap-3">
                            <span class="text-xs px-2 py-0.5 rounded ${cat?.color}">${cat?.label}</span>
                            <span class="font-medium">${e.name}</span>
                            ${e.repeats ? '<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">—Ä–µ–≥—É–ª—è—Ä–Ω–∞</span>' : ''}
                          </div>
                          <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500">${formatCurrency(e.amount, e.currency)}</span>
                            <span class="text-sm font-medium">‚âà ‚Ç¨${Math.round(e.amountEUR)}</span>
                            <button onclick="window.editExpense('${e.id}')" class="p-1 text-gray-400 hover:text-blue-500">${icons.edit}</button>
                            <button onclick="window.removeExpense('${e.id}')" class="p-1 text-gray-400 hover:text-red-500">${icons.trash}</button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `).join('')}

          <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-sm p-6 text-white">
            <div class="text-lg font-medium mb-2">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫</div>
            <div class="grid grid-cols-3 gap-4">
              <div><div class="text-green-100 text-sm">–î–æ—Ö—ñ–¥</div><div class="text-2xl font-bold">‚Ç¨${totalIncome.toLocaleString()}</div></div>
              <div><div class="text-green-100 text-sm">–í–∏—Ç—Ä–∞—Ç–∏</div><div class="text-2xl font-bold">‚Ç¨${Math.round(totalExpenses).toLocaleString()}</div></div>
              <div><div class="text-green-100 text-sm">–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div><div class="text-2xl font-bold">‚Ç¨${Math.round(totalProfit).toLocaleString()}</div></div>
            </div>
          </div>
        </div>
      `;
    };

    const renderAnalytics = () => {
      const profitMap = {};
      clients.forEach(c => {
        const month = getMonthYear(c.startDate);
        if (!profitMap[month]) profitMap[month] = { month, income: 0, expenses: 0 };
        profitMap[month].income += c.paid || 0;
      });
      expenses.forEach(e => {
        if (!profitMap[e.month]) profitMap[e.month] = { month: e.month, income: 0, expenses: 0 };
        profitMap[e.month].expenses += toEUR(e.amount, e.currency);
      });
      const data = Object.values(profitMap).map(m => ({ ...m, profit: m.income - m.expenses })).sort((a, b) => a.month.localeCompare(b.month));
      const maxVal = Math.max(...data.map(m => m.income), 1);

      return `
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">${icons.chart} –î–∏–Ω–∞–º—ñ–∫–∞ –ø–æ –º—ñ—Å—è—Ü—è—Ö</h3>
          <div class="space-y-3">
            ${data.map(m => `
              <div class="flex items-center gap-4">
                <div class="w-20 text-sm font-medium text-gray-600">${getMonthLabelShort(m.month)}</div>
                <div class="flex-1 relative h-8">
                  <div class="absolute inset-0 bg-gray-100 rounded-lg"></div>
                  <div class="absolute left-0 top-0 h-full bg-green-500 rounded-lg" style="width: ${(m.income / maxVal) * 100}%"></div>
                  <div class="absolute left-0 top-0 h-full bg-red-400 rounded-lg opacity-70" style="width: ${(m.expenses / maxVal) * 100}%"></div>
                </div>
                <div class="w-32 text-right">
                  <span class="text-green-600 font-medium">‚Ç¨${Math.round(m.income)}</span>
                  <span class="text-gray-400 mx-1">-</span>
                  <span class="text-red-500">‚Ç¨${Math.round(m.expenses)}</span>
                </div>
                <div class="w-20 text-right font-bold ${m.profit >= 0 ? 'text-green-600' : 'text-red-600'}">‚Ç¨${Math.round(m.profit)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };

    const renderClientModal = () => {
      if (!showAddForm && !editingClient) return '';
      const isEdit = !!editingClient;
      const data = editingClient || { name: '', startDate: '', serviceType: '', contractSum: '', paid: '', repeats: false, comment: '' };

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeClientModal()">
          <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold">${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞' : '–ù–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç'}</h3>
              <button onclick="window.closeClientModal()" class="p-1 text-gray-400 hover:text-gray-600">${icons.close}</button>
            </div>
            <form onsubmit="window.saveClient(event)">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–Ü–º º—è –∫–ª—ñ—î–Ω—Ç–∞ *</label>
                  <input type="text" name="name" value="${data.name || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç—É *</label>
                  <input type="date" name="startDate" value="${data.startDate || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –ø–æ—Å–ª—É–≥–∏ *</label>
                  <select name="serviceType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">–û–±–µ—Ä–∏...</option>
                    ${serviceTypes.map(s => `<option value="${s.value}" ${data.serviceType === s.value ? 'selected' : ''}>${s.label}</option>`).join('')}
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—É–º–∞ ‚Ç¨</label>
                    <input type="number" name="contractSum" value="${data.contractSum || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–ª–∞—á–µ–Ω–æ ‚Ç¨</label>
                    <input type="number" name="paid" value="${data.paid || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" name="repeats" id="repeats" ${data.repeats ? 'checked' : ''} class="w-4 h-4 text-green-500 rounded">
                  <label for="repeats" class="text-sm text-gray-700">–ü–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è</label>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                  <input type="text" name="comment" value="${data.comment || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
              </div>
              <div class="flex gap-2 mt-6">
                <button type="submit" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" onclick="window.closeClientModal()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              </div>
            </form>
          </div>
        </div>
      `;
    };

    const renderExpenseModal = () => {
      if (!showExpenseForm && !editingExpense) return '';
      const isEdit = !!editingExpense;
      const data = editingExpense || { name: '', category: 'services', amount: '', currency: 'USD', month: getCurrentMonth(), repeats: false };

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) window.closeExpenseModal()">
          <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold">${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É' : '–ù–æ–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∞'}</h3>
              <button onclick="window.closeExpenseModal()" class="p-1 text-gray-400 hover:text-gray-600">${icons.close}</button>
            </div>
            <form onsubmit="window.saveExpense(event)">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞ *</label>
                  <input type="text" name="name" value="${data.name || ''}" required placeholder="Claude Pro, Meta Ads..." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                  <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    ${expenseCategories.map(c => `<option value="${c.value}" ${data.category === c.value ? 'selected' : ''}>${c.label}</option>`).join('')}
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—É–º–∞ *</label>
                    <input type="number" name="amount" value="${data.amount || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–í–∞–ª—é—Ç–∞</label>
                    <select name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                      ${currencies.map(c => `<option value="${c.value}" ${data.currency === c.value ? 'selected' : ''}>${c.symbol} ${c.value}</option>`).join('')}
                    </select>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">–ú—ñ—Å—è—Ü—å</label>
                  <input type="month" name="month" value="${data.month || getCurrentMonth()}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" name="repeats" id="expRepeats" ${data.repeats ? 'checked' : ''} class="w-4 h-4 text-green-500 rounded">
                  <label for="expRepeats" class="text-sm text-gray-700">–†–µ–≥—É–ª—è—Ä–Ω–∞</label>
                </div>
              </div>
              <div class="flex gap-2 mt-6">
                <button type="submit" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" onclick="window.closeExpenseModal()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              </div>
            </form>
          </div>
        </div>
      `;
    };

    const render = () => {
      const appEl = document.getElementById('app');

      if (!currentUser) {
        appEl.innerHTML = renderLoginPage();
        return;
      }

      let content = '';
      if (activeTab === 'journal') content = renderJournal();
      else if (activeTab === 'clients') content = renderClients();
      else if (activeTab === 'profit') content = renderProfit();
      else if (activeTab === 'analytics') content = renderAnalytics();

      appEl.innerHTML = `
        ${renderHeader()}
        <main class="max-w-7xl mx-auto px-4 py-4">
          ${renderAlerts()}
          ${renderTabs()}
          ${content}
          <div class="mt-8 text-center text-sm text-gray-400">TALKO Clients Tracker ‚Ä¢ Firebase</div>
        </main>
        ${renderClientModal()}
        ${renderExpenseModal()}
      `;
    };

    // Global handlers
    window.handleSignIn = handleSignIn;
    window.handleSignOut = handleSignOut;
    window.setTab = (tab) => { activeTab = tab; render(); };
    window.openAddClient = () => { showAddForm = true; editingClient = null; render(); };
    window.closeClientModal = () => { showAddForm = false; editingClient = null; render(); };
    window.editClient = (id) => { editingClient = clients.find(c => c.id === id); showAddForm = false; render(); };
    window.removeClient = async (id) => { if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞?')) await deleteClient(id); };
    window.saveClient = async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        name: form.name.value,
        startDate: form.startDate.value,
        serviceType: form.serviceType.value,
        contractSum: parseFloat(form.contractSum.value) || 0,
        paid: parseFloat(form.paid.value) || 0,
        repeats: form.repeats.checked,
        comment: form.comment.value
      };
      if (editingClient) await updateClient(editingClient.id, data);
      else await addClient(data);
      showAddForm = false;
      editingClient = null;
      render();
    };

    window.openAddExpense = () => { showExpenseForm = true; editingExpense = null; render(); };
    window.closeExpenseModal = () => { showExpenseForm = false; editingExpense = null; render(); };
    window.editExpense = (id) => { editingExpense = expenses.find(e => e.id === id); showExpenseForm = false; render(); };
    window.removeExpense = async (id) => { if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É?')) await deleteExpense(id); };
    window.saveExpense = async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        name: form.name.value,
        category: form.category.value,
        amount: parseFloat(form.amount.value) || 0,
        currency: form.currency.value,
        month: form.month.value,
        repeats: form.repeats.checked
      };
      if (editingExpense) await updateExpense(editingExpense.id, data);
      else await addExpense(data);
      showExpenseForm = false;
      editingExpense = null;
      render();
    };

    window.updateRate = (currency, value) => {
      exchangeRates[currency] = parseFloat(value) || 0;
      saveExchangeRates();
      render();
    };

    window.generateNextMonth = async () => {
      const activeRepeating = clients.filter(c => c.repeats && getStatus(c) === 'active');
      if (activeRepeating.length === 0) {
        alert('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ –ø–æ–∑–Ω–∞—á–∫–æ—é "–ü–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è"');
        return;
      }
      for (const c of activeRepeating) {
        const endDate = getEndDate(c.startDate, c.serviceType);
        await addClient({
          name: c.name,
          startDate: endDate ? endDate.toISOString().split('T')[0] : '',
          serviceType: c.serviceType,
          contractSum: c.contractSum,
          paid: 0,
          repeats: true,
          comment: '–ê–≤—Ç–æ–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è'
        });
      }
      alert(`–î–æ–¥–∞–Ω–æ ${activeRepeating.length} –∑–∞–ø–∏—Å—ñ–≤`);
    };

    // Initial render
    render();
  </script>
</body>
</html>